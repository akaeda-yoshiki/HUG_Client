<!DOCTYPE html>
<html>

<head>
        <meta charset="UTF-8" />
        <title>プレイ画面</title>
        <script type="text/javascript" src="define.js"> </script>
        <script src="https://code.jquery.com/jquery-1.9.0.min.js"></script>
        <script type="text/javascript" src="jquery.balloon.js"></script>
        <style>
                .block1 {
                        background: rgb(209, 231, 255);
                        width: 60%;
                        font-size: 20px;
                        padding: 0.5em 0.5em;
                        position: relative;
                        left: 7%;
                }

                .block2 {
                        background: rgb(236, 245, 255);
                        width: 60%;
                        font-size: 20px;
                        padding: 0.5em 0.5em;
                        position: relative;
                        left: 7%;
                }


                textarea {
                        width: 70%;
                        resize: none;
                        position: relative;
                        left: 70px;
                }

                .textarea_smoll {
                        width: 70%;
                        height: 60px;
                        position: relative;
                        left: 55px;
                }

                draw_area {
                        width: 70%;
                        height: 20px;
                        position: relative;
                        left: 30px;
                }

                .theme_box {
                        padding: 0.5em 1em;
                        color: #000000;
                        background: #9ee7a4;
                        border-bottom: solid 6px #7cf090;
                        border-radius: 9px;
                        width: 25%;
                        height: 100px;
                        position: absolute;
                        left: 70%;
                }


                .hide_black {
                        background: #000000;
                        opacity: 0.7;
                        width: 100%;
                        height: 100%;
                        position: absolute;
                        top: 0px;
                        left: 0px;
                        z-index: 1;
                }
        </style>
        <script>


                $('texi_and_pop').balloon();//マウスオーバーの割り当て

                var assessment_data = [];
                //受信
                $(document).ready(function () {
                        window.sessionStorage.setItem(["eventcode"], "5SrgaP0MjG");
                        get_theme_detail();

                        var list = '<option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>';

                        if (DEBUG)
                                $.ajax({ //非同期通信
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                        data: {
                                                code: window.sessionStorage.getItem(["eventcode"])
                                        },
                                        success: function (data1) {
                                                // alert(data1);
                                                $.ajax({ //非同期通信
                                                        type: "POST",
                                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/theme.php",
                                                        data: {
                                                                id: data1
                                                        },
                                                        success: function (data) {
                                                                var text1 = '<br><a style="position: relative;left: 140px;">';
                                                                var text2 = '：</a><select id="assessment_list';
                                                                var text3 = '" style="position: relative;width: 50px;left: 158px;">';

                                                                var add = "";
                                                                add += '<a style="position: relative;left: 40px;">' + data[0].assessment0 + '：</a>';
                                                                add += '<select id="assessment_list' + 0 + '" style="position: relative;width: 50px;left: 60px;">';
                                                                $("#assessment_list").append(add + list);
                                                                assessment_data.push(data[0].assessment0);
                                                                if (data[0].assessment1 != "") { $("#assessment_list").append(text1 + data[0].assessment1 + text2 + 1 + text3 + list); assessment_data.push(data[0].assessment1); }
                                                                if (data[0].assessment2 != "") { $("#assessment_list").append(text1 + data[0].assessment2 + text2 + 2 + text3 + list); assessment_data.push(data[0].assessment2); }
                                                                if (data[0].assessment3 != "") { $("#assessment_list").append(text1 + data[0].assessment3 + text2 + 3 + text3 + list); assessment_data.push(data[0].assessment3); }
                                                                if (data[0].assessment4 != "") { $("#assessment_list").append(text1 + data[0].assessment4 + text2 + 4 + text3 + list); assessment_data.push(data[0].assessment4); }
                                                                if (data[0].assessment5 != "") { $("#assessment_list").append(text1 + data[0].assessment5 + text2 + 5 + text3 + list); assessment_data.push(data[0].assessment5); }
                                                                if (data[0].assessment6 != "") { $("#assessment_list").append(text1 + data[0].assessment6 + text2 + 6 + text3 + list); assessment_data.push(data[0].assessment6); }
                                                                if (data[0].assessment7 != "") { $("#assessment_list").append(text1 + data[0].assessment7 + text2 + 7 + text3 + list); assessment_data.push(data[0].assessment7); }
                                                                if (data[0].assessment8 != "") { $("#assessment_list").append(text1 + data[0].assessment8 + text2 + 8 + text3 + list); assessment_data.push(data[0].assessment8); }
                                                                if (data[0].assessment9 != "") { $("#assessment_list").append(text1 + data[0].assessment9 + text2 + 9 + text3 + list); assessment_data.push(data[0].assessment9); }

                                                        },
                                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                                // alert('エラーです！'); //エラーを表示
                                                        }
                                                });
                                        },
                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                // alert('エラーです！'); //エラーを表示
                                        }
                                });
                });

                //テーマの詳細を受信
                function get_theme_detail() {
                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        code: window.sessionStorage.getItem(["eventcode"])
                                },
                                success: function (data1) {
                                        // alert(data1);
                                        $.ajax({ //非同期通信
                                                type: "POST",
                                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/theme.php",
                                                data: {
                                                        id: data1
                                                },
                                                success: function (data) {
                                                        // タイトル
                                                        $("#title_text").empty();
                                                        $("#title_text").append(data[0].title);
                                                        // カテゴリー
                                                        $("#category_text").empty();
                                                        $("#category_text").append(data[0].category);

                                                        //状況
                                                        $("#situation_text").empty();
                                                        $("#situation_text").append(data[0].situation);
                                                        // 評価項目
                                                        $("#assessment_text").empty();
                                                        $("#assessment_text").append(data[0].assessment0);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment1);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment2);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment3);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment4);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment5);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment6);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment7);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment8);
                                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment9);
                                                        // 日時・時期
                                                        $("#time_text").empty();
                                                        $("#time_text").append(data[0].time);

                                                        // 地域
                                                        $("#area_text").empty();
                                                        $("#area_text").append(data[0].area);

                                                        // 画像
                                                        $("#image_text").empty();
                                                        // $("#image_text").append(data[0].image);
                                                        if (data[0].image != "" && data[0].image != null)
                                                                $("#image_text").append('<img src="http://192.168.0.159/2018grade4/HUG/HUG_Server/image/' + data[0].id + '.jpeg">');

                                                        // 対象者
                                                        $("#target_text").empty();
                                                        $("#target_text").append(data[0].target);

                                                        // ねらい
                                                        $("#aim_text").empty();
                                                        $("#aim_text").append(data[0].aim);

                                                        // 公開の可否
                                                        $("#open_text").empty();
                                                        $("#open_text").append(data[0].open);

                                                        receive_flag = 0;
                                                },
                                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                        // alert('エラーです！'); //エラーを表示
                                                }
                                        });
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        // alert('エラーです！'); //エラーを表示
                                }
                        });
                }


        </script>
</head>

<body>
        <br>
        <br> <br>
        <div class="theme_box" style="height:20px;width: 100px;">
                <center>
                        <a href='#!' onclick='overview("on", "1")' class='square_btn'>テーマ確認</a>
                </center>
        </div>
        <div class="theme_box" style="top: 130px;">
                【概要】<br> 現在時刻
                <br> 経過時間
                <br>
                <center>
                        <a href='#!' onclick='overview("on", "2")' class='square_btn'>詳細</a></center>
        </div>
        <!-- <a id="detail_box"> -->



        <div class="hide_black" id="black_box"style="display: none;"></div>
        <div class="theme_box" id="theme_detail_box" style="display: none;width: 60%;height: 50%;position: absolute;top: 20%;left: 17%;z-index: 1;">

                <center> <a href='#!' onclick='overview("off")' class='square_btn'>閉じる</a></center>
                タイトル
                <draw_area id="title_text" style="position: relative;left: 50px;"></draw_area>

                <br> カテゴリー
                <draw_area id="category_text" style="position: relative;left: 35px;"></draw_area>
                <br> 状況
                <draw_area id="situation_text" style="position: relative;left: 83px;"></draw_area>
                <br> 評価項目
                <draw_area id="assessment_text" style="position: relative;left: 50px;"></draw_area>
                <br> 日時/時期
                <draw_area id="time_text" style="position: relative;left: 50px;"></draw_area>
                <br> 地域
                <draw_area id="area_text" style="position: relative;left: 90px;"></draw_area>
                <br> 画像
                <div id="image_text" style="position: relative;left: 90px;"></div>

                対象者
                <draw_area id="target_text" style="position: relative;left: 70px;"></draw_area>
                <br> ねらい
                <draw_area id="aim_text" style="position: relative;left: 70px;"></draw_area>
                <br>
        </div>
        <div class="theme_box" id="overview_detail_box" style="display: none;width: 60%;height: 50%;position: absolute;top: 20%;left: 17%;z-index: 1;">
                <center> <a href='#!' onclick='overview("off")' class='square_btn'>閉じる</a></center>

        </div>
        <form id="input1">
                <!-- 状況 -->
                <div class="block1">
                        <text_and_pop id="situation_input_text" title="発生した状況の詳細を入力してください">状況*</text_and_pop>
                        <input type="text" id="situation" class="textarea_smoll" required>
                </div>
                <!-- 評価項目 -->
                <div class="block2">
                        <text_and_pop id="assessment_input_text" title="評価項目についてどれくらい関連度があるか入力して下さい">評価項目*</text_and_pop>
                        <assessment_list id="assessment_list"></assessment_list>
                </div>
        </form>

        <!-- 画像 -->
        <div class="block1" id="input0">
                <text_and_pop title="施設内の地図など避難所に関する画像を選択してください">画像</text_and_pop>

                <form id="file_input" action="http://192.168.0.159/2018grade4/HUG/HUG_Server/file_upload.php" method="post" enctype="multipart/form-data">
                        <!-- <br> -->
                        <input type="file" name="pic" id="image_file" style="position: relative; left:128px;top:-20px;" onchange="image_update()">
                        <!-- <br> -->
                </form>
                <div id="image_input_draw"></div>
        </div>
        <script>
                // 画像が選択されたら表示
                function image_update() {
                        var file = document.getElementById("image_file").files;
                        var reader = new FileReader();
                        reader.readAsDataURL(file[0]); //dataURL形式でファイルを読み込む

                        reader.onload = function () {//ファイルの読込が終了した時の処理
                                var dataUrl = reader.result;

                                //読み込んだ画像の表示（入力画面、確認画面）
                                document.getElementById("image_input_draw").innerHTML = "<br><center><img src='" + dataUrl + "'></center>";
                                document.getElementById("image_draw").innerHTML = "<br><center><img src='" + dataUrl + "'></center>";

                                // ファイル名のみ取得して表示します
                                var selectFileSample4 = document.getElementById("image_file").value;
                                var regex = /\\|\\/;
                                var array = selectFileSample4.split(regex);

                                image_send = array[array.length - 1];
                                image_send = image_send.split(".")[1];
                        }
                };
        </script>
        <form id="input2">
                <center>
                        <!-- エラーメッセージ -->
                        <a id="required_error" style="color: red;display: none;">入力内容に不備があります。
                                <br>
                                <br>
                        </a>

                        <input type="button" value="次へ" onclick="next()">
                </center>
        </form>
        <!-- 確認画面 *************************************************************-->
        <form id="draw" style="display: none;">
                <div class="block1" id="situation">
                        状況*
                        <draw_area id="situation_text"></draw_area>
                </div>

                <div class="block2">
                        評価項目*
                        <draw_area id="assessment_text"></draw_area>
                </div>
                <div class="block1">
                        画像
                        <div id="image_draw"></div>

                </div>
                <br>
                <center>
                        <!-- ボタン -->
                        <input type="button" value="訂正" onclick="back()"> &nbsp; &nbsp; &nbsp; &nbsp;
                        <input type="button" value="内容確定" onclick="decide()">
                </center>
        </form>
        <script>
                var assessment_send = [], category_send, time_send = "", image_send = "";//登録時に送信する用
                //次へボタンが押された時
                function next() {
                        var required_flag = true;//入力必須事項の確認用
                        var get1 = document.forms.input1;
                        var get2 = document.forms.input2;

                        // 状況
                        $("#situation_text").empty();
                        $("#situation_text").append(get1.situation.value);
                        document.getElementById("situation_input_text").style.color = "";
                        if (get1.situation.value == "") {
                                required_flag = false;
                                document.getElementById("situation_input_text").style.color = "red";
                        }

                        // 評価項目
                        $("#assessment_text").empty();
                        for (var i = 0; i < assessment_data.length; i++) {
                                document.getElementById("assessment_input_text").style.color = "";
                                // $("#assessment_text").append(get1.assessment_list.value);
                                if (i != 0)
                                        $("#assessment_text").append('<a style="position: relative;left: 135px;">' + assessment_data[i] + "：" + document.getElementById("assessment_list" + i).value + '</a>');
                                else
                                        $("#assessment_text").append('<a style="position: relative;left: 36px;">' + assessment_data[i] + "：" + document.getElementById("assessment_list" + i).value + '</a>');
                                $("#assessment_text").append("<br>");
                                assessment_send.push(document.getElementById("assessment_list" + i).value);
                        }



                        // 入力必須事項の確認
                        if (required_flag == true) {
                                document.getElementById("input1").style.display = "none";
                                document.getElementById("input2").style.display = "none";
                                document.getElementById("input0").style.display = "none";
                                document.getElementById("draw").style.display = "";

                                document.getElementById("required_error").style.display = "none";

                        }
                        else {
                                document.getElementById("required_error").style.display = "";

                        }
                }

                //訂正ボタンが押された
                function back() {
                        document.getElementById("input1").style.display = "";
                        document.getElementById("input2").style.display = "";
                        document.getElementById("input0").style.display = "";
                        document.getElementById("draw").style.display = "none";
                }
                var send_f = 1;

                //内容確定ボタンが押された
                function decide() {
                        var get1 = document.forms.input1;
                        var get2 = document.forms.input2;
                        if (send_f == 1) {
                                send_f = 0;
                                $.ajax({ //非同期通信
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                        data: {
                                                data1: get1.situation.value,
                                                data2: assessment_send.join("/"),
                                                data3: "",
                                                code: window.sessionStorage.getItem(["eventcode"]),
                                                mode: "insert",
                                                id: 2
                                        },
                                        success: function (data) {
                                                // alert(data);
                                                if (data == "ok") {
                                                        window.location.href = "pm.html";
                                                }
                                                else {
                                                        alert("ok以外");
                                                }
                                                send_f = 1;
                                        },
                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                // alert('エラーです！'); //エラーを表示
                                                send_f = 1;
                                        }
                                });
                        }
                }
                function file() {
                        // var form = document.getElementById("file_input");
                        // var formdata = new FormData(form);
                        // $.ajax({
                        //         type: 'POST',
                        //         url: 'http://192.168.0.159/2018grade4/HUG/HUG_Server/file_upload.php',
                        //         data: formdata,
                        //         processData: false,	// jQueryがデータを処理しないように設定
                        //         contentType: false,	// jQueryがcontentTypeを設定しないように設定
                        //         success: function (data) {
                        //                 // alert("success::" + data)
                        //         },
                        //         error: function (data) {
                        //                 // alert("error:" + data.statusText);
                        //         }
                        // });
                }



                function overview(h, n) {
                        if (h == "on") {
                                document.getElementById("black_box").style.display = "";
                                if (n == "1")
                                        document.getElementById("theme_detail_box").style.display = "";
                                else if (n == "2")
                                        document.getElementById("overview_detail_box").style.display = "";
                        } else if (h == "off") {
                                document.getElementById("black_box").style.display = "none";
                                document.getElementById("theme_detail_box").style.display = "none";
                                document.getElementById("overview_detail_box").style.display = "none";


                        }
                }
        </script>

</body>

</html>