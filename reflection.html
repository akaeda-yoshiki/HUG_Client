<!DOCTYPE html>
<html>

<head>
        <meta charset="UTF-8" />
        <title>HUG</title>
        <link rel="stylesheet" type="text/css" href="header.css">
        <script type="text/javascript" src="menu.js"> </script>
        <link rel="stylesheet" type="text/css" href="play.css">
        <script src="https://code.jquery.com/jquery-1.9.0.min.js"></script>

        <style>
                table {
                        width: 85%;
                        position: relative;
                        left: 7%;
                        padding: 0;
                        border: 0;
                        border-spacing: 0;
                        border-collapse: collapse;
                }

                th {
                        font: bold 11px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif;
                        color: #ffffff;
                        font-size: 16px;
                        /* border: 1px solid #0e100f; */
                        letter-spacing: 2px;
                        text-transform: uppercase;
                        text-align: left;
                        padding: 6px 6px 6px 12px;
                        background: #59b1b8;
                        border-left: none;
                        border-right: none;
                }

                td {
                        border: 1px solid #59b1b8;
                        background: #fff;
                        padding: 6px 6px 6px 12px;
                        color: #151a1b;
                        border-left: none;
                        border-right: none;

                }

                .block1 {
                        background: rgb(209, 231, 255);
                        width: 85%;
                        font-size: 20px;
                        padding: 0.5em 0.5em;
                        position: relative;
                        left: 7%;
                }

                .block2 {
                        background: rgb(236, 245, 255);
                        width: 85%;
                        font-size: 20px;
                        padding: 0.5em 0.5em;
                        position: relative;
                        left: 7%;
                }

                .block3 {
                        background: #d9edfd;
                        width: 85%;
                        font-size: 20px;
                        padding: 0.5em 0.5em;
                        position: relative;
                        left: 7%;
                        border: solid 2px #b4b6c2;
                }
        </style>
        <script>
                var reflection_eventcode = "";
                $(document).ready(function () {

                        if (window.sessionStorage.getItem(["reflection"]) == null) {
                                get_theme();

                                //マスターテーブルからカテゴリーを受信
                                $.ajax({
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/category.php",
                                        dataType: "json",
                                }).done(function (data, dataType) {
                                        //カテゴリーのプルダウンに追加
                                        for (var i = 0; i < data.length; i++) {
                                                if (data[i].word != "入力")
                                                        $('#search_category').append($('<option>').html(data[i].word).val(data[i].word));
                                        }
                                }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                                        // alert('Error : ' + errorThrown);
                                });

                                //マスターテーブルから評価項目を受信
                                $.ajax({
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/assessment.php",
                                        dataType: "json",
                                }).done(function (data, dataType) {
                                        //評価項目のチェックリストに追加
                                        for (var i = 0; i < data.length; i++) {
                                                $('#search_assessment').append($('<option>').html(data[i].word).val(data[i].word));
                                        }
                                }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                                        // alert('Error : ' + errorThrown);
                                });
                        }
                        else {
                                theme_detail(window.sessionStorage.getItem(["reflection"]));
                                start_reflection();
                                sessionStorage.removeItem(["reflection"]);
                        }
                });

        </script>
</head>

<body>
        <prepare id="prepare">
                <script type="text/javascript">
                        write_header(3);
                </script>

                <br>
                <div class="block3">
                        <form id="search">
                                絞り込み
                                <!-- <br> -->
                                <a style="position: relative; left:30px;">
                                        イベントコード
                                        <input type="text" id="search_code" style="position: relative; left:68px;">
                                </a><br>
                                <a style="position: relative; left:115px;">
                                        テーマタイトル
                                        <input type="text" id="search_title" style="position: relative; left:68px;">
                                        <br>カテゴリー
                                        <select id="search_category" style="width: 172px;position: relative; left:110px;">
                                                <option value=""></option>
                                        </select>
                                        <!-- <input type="text" id="search_category" style="position: relative; left:110px;"> -->
                                        <br> 状況
                                        <input type="text" id="search_situation" style="position: relative; left:170px;">
                                        <br> 日時・時期
                                        <input type="text" id="search_time" style="position: relative; left:110px;">
                                        <br> 地域
                                        <input type="text" id="search_area" style="position: relative; left:170px;">
                                        <br> 対象者
                                        <input type="text" id="search_target" style="position: relative; left:150px;">
                                        <br> ねらい
                                        <input type="text" id="search_aim" style="position: relative; left:150px;">
                                        <br> 評価項目
                                        <select id="search_assessment" style="width: 172px;position: relative; left:130px;">
                                                <option value=""></option>
                                        </select>
                                        <!-- <input type="text" id="search_assessment" style="position: relative; left:130px;"> -->
                                        <br>
                                        <br>
                                        <input type="button" value="絞り込む" onclick='get_theme()'>
                                </a>
                        </form>
                </div>
                <br>

                <br>
                <a id="table">
                        <b style="position: relative; left:7%;" id="myevent_table_title">
                                マイイベント</b>
                        <input type="button" id="get_theme_button" style="position: relative; left:7%;" value="全てのテーマ"
                                onclick='exchange_volume("all", 0)'>
                        <input type="button" id="back_button" style="position: relative; left:7%;display: none;" value="戻る"
                                onclick='exchange_volume("not_all", 0)'>

                        <table id='mytable'>
                        </table>
                        <br>
                        <b style="position: relative; left:7%;" id="everyone_table_title">
                                みんなのイベント</b>
                        <input type="button" id="get_theme_button1" style="position: relative; left:7%;" value="全てのテーマ"
                                onclick='exchange_volume("all", 1)'>
                        <input type="button" id="back_button1" style="position: relative; left:7%;display: none;" value="戻る"
                                onclick='exchange_volume("not_all", 1)'>

                        <table id='everyone_table'>
                        </table>
                </a>

                <!-- 確認画面 *************************************************************-->
                <form id="detail" style="display: none;">
                        <div class="block1" id="title">
                                タイトル
                                <draw_area id="title_text" style="position: relative;left: 50px;"></draw_area>
                        </div>

                        <div class="block2">
                                カテゴリー
                                <draw_area id="category_text" style="position: relative;left: 30px;"></draw_area>
                        </div>
                        <div class="block1">
                                状況
                                <draw_area id="situation_text" style="position: relative;left: 90px;"></draw_area>
                        </div>
                        <div class="block2">
                                評価項目
                                <draw_area id="assessment_text" style="position: relative;left: 50px;"></draw_area>
                        </div>
                        <div class="block1">
                                日時/時期
                                <draw_area id="time_text" style="position: relative;left: 50px;"></draw_area>

                        </div>
                        <div class="block2">
                                地域
                                <draw_area id="area_text" style="position: relative;left: 90px;"></draw_area>
                        </div>
                        <div class="block1">
                                画像
                                <div id="image_text" style="position: relative;left: 90px;"></div>

                        </div>
                        <div class="block2">
                                対象者
                                <draw_area id="target_text" style="position: relative;left: 70px;"></draw_area>
                        </div>
                        <div class="block1">
                                ねらい
                                <draw_area id="aim_text" style="position: relative;left: 70px;"></draw_area>
                        </div>
                        <div class="block2">
                                作成者
                                <draw_area id="name_text" style="position: relative;left: 70px;"></draw_area>
                        </div>
                        <div class="block2">
                                公開可否
                                <draw_area id="open_text" style="position: relative;left: 50px;"></draw_area>
                        </div>
                        <br>
                        <input type="button" id="play_button1" style="position: relative; left:7%;" value="振り返りを開始"
                                onclick='start_reflection()'>
                </form>
        </prepare>
        <reflection id="reflection" style="display: none;">
                <!-- テーマボタン -->
                <b class="theme_box" style="position: -webkit-sticky;
                position: sticky;left:82%;height:20px;width: 100px;top:8%;">
                        <a href='#!' onclick='overview("on", "1")' class='square_btn'>テーマ確認</a>
                </b>
                <!-- 終了ボタン -->
                <b class="theme_box" style="position: -webkit-sticky;
                position: sticky;top:8%;height:20px;width:40px;left:92%;background: #9edce7;border-bottom: solid 6px #9edce7;">
                        <a href='#!' onclick='window.location.href = "reflection.html";' class='square_btn'>終了</a>
                </b>
                <br><br><br><br><br>
                <!-- コメント -->
                <div class="theme_box" id="situation_detail_box" style="position: -webkit-sticky;
                position: sticky;width: 15%;height: auto;top: 15%;left: 82%;">
                        コメントを付けたり、見たりすることができます
                        <a id="comment_view"></a>
                        <a id="comment_input" style="display: none;">
                                <textarea id="comment_input_text" rows="3" style="width: 100%;position: relative;left: 0px;"></textarea>
                                <input type="button" style="position: relative; left:7%;" value="次へ" onclick='next_comment()'>
                                <input type="button" style="position: relative; left:7%;" value="やめる" onclick='stop_comment()'>
                        </a>
                        <br>
                        <a id="comment_confirm" style="display: none;">
                                <b id="comment_confirm_text"></b>
                                <br>
                                <input type="button" style="position: relative; left:7%;" value="内容確定" onclick='decide_comment()'>
                                <input type="button" style="position: relative; left:7%;" value="やめる" onclick='stop_comment()'>

                        </a>
                </div>
                <!-- 半透明の黒 -->
                <div class="hide_black" id="black_box" style="display: none;" onclick='overview("off")'></div>
                <!-- テーマ内容 -->
                <div class="theme_box" id="theme_detail_box" style="display: none;width: auto;height: auto;position: absolute;top: 20%;left: 17%;z-index: 1;">

                        <center> <a href='#!' onclick='overview("off")' class='square_btn'>閉じる</a></center>
                        タイトル
                        <draw_area id="theme_title_text" style="position: relative;left: 50px;"></draw_area>
                        <br> カテゴリー
                        <draw_area id="theme_category_text" style="position: relative;left: 35px;"></draw_area>
                        <br> 状況
                        <draw_area id="theme_situation_text" style="position: relative;left: 83px;"></draw_area>
                        <br> 評価項目
                        <draw_area id="theme_assessment_text" style="position: relative;left: 50px;"></draw_area>
                        <br> 日時/時期
                        <draw_area id="theme_time_text" style="position: relative;left: 50px;"></draw_area>
                        <br> 地域
                        <draw_area id="theme_area_text" style="position: relative;left: 90px;"></draw_area>

                        <br>
                        対象者
                        <draw_area id="theme_target_text" style="position: relative;left: 70px;"></draw_area>
                        <br> ねらい
                        <draw_area id="theme_aim_text" style="position: relative;left: 70px;"></draw_area>
                        <br> 画像<br>
                        <div id="theme_image_text" style="position: relative;left: 0px;"></div>
                </div>
                <!-- トレース -->
                <div class="theme_box" id="trace_box" style="display: none;width: 60%;height: auto;top: 20%;left: 17%;z-index: 1;">
                        【トレース】

                        <a id="id23"></a>
                        <a id="id4"></a>

                        <center> <a href='#!' onclick='overview("off")' class='square_btn'>閉じる</a></center>

                </div>
                <!-- 履歴詳細 -->
                <div class="theme_box" id="situation_detail_box" style="position: absolute;width: 70%;height: auto;top: 8%;left: 8%;">
                        【全ての履歴】
                        <br>
                        <br><a id="situation_detail_box_add"></a>
                </div>

        </reflection>
        <br>
        <script>
                var eventcode = "";
                var now_mode = "not_all";

                function start_reflection() {
                        $(window).scrollTop(0);
                        document.getElementById("prepare").style.display = "none";
                        document.getElementById("reflection").style.display = "";
                        // setInterval(function(){get_history(reflection_eventcode)}, 500);
                        // get_history();
                }

                //表示するテーマの数を切り替え
                function exchange_volume(word, h) {


                        if (word == "all") {//全件表示
                                if (h == 0) {
                                        document.getElementById("everyone_table").style.display = "none";
                                        document.getElementById("back_button").style.display = "";
                                        document.getElementById("everyone_table_title").style.display = "none";
                                }
                                else {
                                        document.getElementById("mytable").style.display = "none"; document.getElementById("back_button1").style.display = "";
                                        document.getElementById("myevent_table_title").style.display = "none";
                                }
                                now_mode = "all";
                                document.getElementById("get_theme_button").style.display = "none";
                                document.getElementById("get_theme_button1").style.display = "none";
                                get_theme();
                        } else if (word == "not_all") {//一部表示
                                now_mode = "not_all";
                                document.getElementById("get_theme_button").style.display = "";
                                document.getElementById("get_theme_button1").style.display = "";
                                document.getElementById("back_button").style.display = "none";
                                document.getElementById("back_button1").style.display = "none";
                                document.getElementById("everyone_table").style.display = "";
                                document.getElementById("mytable").style.display = "";
                                document.getElementById("everyone_table_title").style.display = "";
                                document.getElementById("myevent_table_title").style.display = "";
                                get_theme();
                        }
                        else if (document.getElementById("detail").style.display == "") {
                                document.getElementById("get_theme_button").style.display = "";
                                document.getElementById("get_theme_button1").style.display = "";
                                document.getElementById("back_button").style.display = "none";
                                document.getElementById("back_button1").style.display = "none";
                                document.getElementById("everyone_table").style.display = "";
                                document.getElementById("mytable").style.display = "";
                                document.getElementById("everyone_table_title").style.display = "";
                                document.getElementById("myevent_table_title").style.display = "";
                                get_theme();
                        }
                }




                //履歴データの受信と表示
                function get_history(get) {
                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        code: get,
                                        id: "-1"
                                },
                                success: function (data) {
                                        adjustment_history(data);
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        // console.log("ID4データ受信エラー");
                                        // console.log("XMLHttpRequest::" + XMLHttpRequest);
                                        // console.log("textStatus::" + textStatus);
                                        // console.log("errorThrown::" + errorThrown);
                                        // adjustment_history(data);
                                }
                        });

                }


                //履歴データをIDごとに処理
                function adjustment_history(data) {
                        $("#situation_detail_box_add").empty();
                        var first_data = 1;

                        // ソート
                        data.sort(function (a, b) {
                                if (Number(a.num) < Number(b.num)) return 1;
                                if (Number(a.num) > Number(b.num)) return -1;
                                return 0;
                        });

                        var add = "", class_name, color;
                        for (var i = data.length - 1; i > -1; i--) {
                                if (data[i].id == "2" || data[i].id == "3" || data[i].id == "4") {
                                        data[i].judg = "";
                                        data[i].comment_count = 0;
                                        for (var j = 0; j < data.length; j++) {
                                                switch (data[i].id) {
                                                        case "2":
                                                        case "3":
                                                                if (data[j].id == "4" && data[j].data2 == data[i].num)
                                                                        data[i].judg = "trace";
                                                        case "4":
                                                                if (data[j].id == "7" && data[j].data2 == data[i].num) {
                                                                        data[i].comment_count++;
                                                                }
                                                                break;


                                                                break;
                                                }
                                        }
                                        if (data[i].id == "2") {
                                                class_name = "block1";
                                                color = "#f7fdc4";
                                        }
                                        else if (data[i].id == "3") {
                                                class_name = "block2";
                                                color = "#fff8ef";
                                        }
                                        else if (data[i].id == "4") {
                                                class_name = "block1";
                                                color = "#e0ffff";
                                        }

                                        //全ての履歴
                                        if (first_data == 1) {
                                                add = "<div class='" + class_name + "' style='width:90%;left:4%;font-size: 13px;border:1px solid green;background: " + color + ";'>";
                                                first_data = 0;
                                        }
                                        else
                                                add = "<div class='" + class_name + "' style='width:90%;left:4%;font-size: 13px;border:1px solid green;border-top:0px solid green;background: " + color + ";'>";

                                        add += set_history_data(data[i], "reflection");
                                        add += "</div> ";
                                        $("#situation_detail_box_add").append(add);
                                }
                        }
                }

                //履歴データの書き込み
                function set_history_data(data, h) {
                        var sentence = "", left = "5px";
                        if (data.data4 == "") {
                                left = "38px";
                        }
                        switch (data.id) {
                                case "2":
                                        sentence += "【状況カード】" + data.data4;

                                        sentence += "<br>";
                                        sentence += data.data1;
                                        if (data.data3 != "") {
                                                var image = '"' + data.data3 + '"';
                                                if (h == "all" || h == "trace" || h == "reflection") {
                                                        sentence += "<br>" + "<a href='#!' onclick='exchange_history_image_not_view(" + image + ")' id='" + data.data3 + "_not_view' style='display: none;'class='square_btn'>画像を非表示</a>";
                                                        sentence += "<a href='#!' onclick='exchange_history_image_view(" + image + ")' id='" + data.data3 + "_view_all' class='square_btn'>画像を表示</a>";
                                                        sentence += '<img src="http://192.168.0.159/2018grade4/HUG/HUG_Server/image/' + data.data3 + '.jpeg" id="' + data.data3 + '" style="display: none;">';
                                                } else if (h == "part") {
                                                        sentence += "<br>" + "<a href='#!' onclick='exchange_part_history_image_view(" + image + ")' id='" + data.data3 + "_view_part' class='square_btn'>画像を表示</a>";
                                                        document.getElementById("history_image_detail_box_img").src = "http://192.168.0.159/2018grade4/HUG/HUG_Server/image/" + data.data3 + ".jpeg";
                                                }
                                        }

                                        break;
                                case "3":
                                        sentence += "【人間カード】" + data.data4;
                                        sentence += data.data3 + "&nbsp;&nbsp;" + data.data2 + "<br>" + data.data1;

                                        break;
                                case "4":
                                        sentence += "【対応】" + data.data4 + "<br>";

                                        sentence += data.data1;
                                        if (data.data3 != "") {
                                                var image = '"' + data.data3 + '"';
                                                if (h == "all" || h == "trace" || h == "reflection") {
                                                        sentence += "<br>" + "<a href='#!' onclick='exchange_history_image_not_view(" + image + ")' id='" + data.data3 + "_not_view' style='display: none;'class='square_btn'>画像を非表示</a>";
                                                        sentence += "<a href='#!' onclick='exchange_history_image_view(" + image + ")' id='" + data.data3 + "_view_all' class='square_btn'>画像を表示</a>";
                                                        sentence += '<img src="http://192.168.0.159/2018grade4/HUG/HUG_Server/image/' + data.data3 + '.jpeg" id="' + data.data3 + '" style="display: none;">';
                                                } else if (h == "part") {
                                                        sentence += "<br>" + "<a href='#!' onclick='exchange_part_history_image_view(" + image + ")' id='" + data.data3 + "_view_part' class='square_btn'>画像を表示</a>";
                                                        document.getElementById("history_image_detail_box_img").src = "http://192.168.0.159/2018grade4/HUG/HUG_Server/image/" + data.data3 + ".jpeg";
                                                }
                                        }

                                        break;
                                case "7":
                                        sentence += "【コメント】<br>" + data.data1;
                                        break;

                        }
                        if ((h == "all" || h == "trace" || h == "reflection") && data.judg == "trace")
                                sentence += "<br><a href='#!' onclick='trace_history(" + data.num + ")' class='square_btn'>たどる</a>";
                        if (h == "reflection") {
                                sentence += "<br><a href='#!' onclick='comment_start(" + data.num + ")' class='square_btn'>コメントをつける</a>";
                                if (data.comment_count != 0)
                                        sentence += "<br><a href='#!' onclick='comment_view(" + data.num + ")' class='square_btn'>コメント見る(" + data.comment_count + ")</a>";
                        }
                        return sentence;
                }

                //対応からたどる
                function trace_history(num) {
                        // 状況・人間
                        // numがdata2の対応

                        // 対応
                        // data2のnumの状況・人間、data2が一緒の対応
                        // console.log(num + "::");
                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        code: eventcode,
                                        num: num,
                                        mode: "trace"
                                },
                                success: function (data) {
                                        overview("on", "5");
                                        $("#id23").empty();
                                        $("#id4").empty();

                                        // ソート
                                        data.sort(function (a, b) {
                                                if (Number(a.num) < Number(b.num)) return 1;
                                                if (Number(a.num) > Number(b.num)) return -1;
                                                return 0;
                                        });

                                        var add = "", class_name, color;
                                        for (var i = data.length - 1; i > -1; i--) {
                                                if (data[i].id == "2") {
                                                        class_name = "block1";
                                                        color = "#f7fdc4";
                                                }
                                                else if (data[i].id == "3") {
                                                        class_name = "block2";
                                                        color = "#fff8ef";
                                                }
                                                else if (data[i].id == "4") {
                                                        class_name = "block1";
                                                        color = "#e0ffff";
                                                }

                                                //全ての履歴
                                                if (data[i].id == "4")
                                                        add = "<div class='" + class_name + "' style='width:90%;left:4%;font-size: 13px;border:1px solid green;border-top:0px solid green;background: " + color + ";'>";
                                                else
                                                        add = "<div class='" + class_name + "' style='width:90%;left:4%;font-size: 13px;border:1px solid green;background: " + color + ";'>";
                                                add += set_history_data(data[i], "trace");
                                                add += "</div> ";
                                                if (data[i].id == "2" || data[i].id == "3")
                                                        $("#id23").append(add);
                                                else if (data[i].id == "4")
                                                        $("#id4").append(add);
                                        }
                                        // console.log(data);
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        console.log("トレースエラー");
                                        console.log("XMLHttpRequest::" + XMLHttpRequest);
                                        console.log("textStatus::" + textStatus);
                                        console.log("errorThrown::" + errorThrown);
                                }
                        });
                }

                //テーマを受信、引数  all：全公開可テーマ　not_all：最新５つの公開可テーマ
                function get_theme() {
                        //イベントコードから「終了・公開可」かつ
                        document.getElementById("table").style.display = "";
                        document.getElementById("detail").style.display = "none";



                        var get = document.forms.search;
                        // console.log(search.search_title);
                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/reflection.php",
                                data: {
                                        mode: now_mode,
                                        search_code: search.search_code.value,
                                        title: search.search_title.value,
                                        category: search_category.value,
                                        situation: search_situation.value,
                                        time: search_time.value,
                                        area: search_area.value,
                                        target: search_target.value,
                                        aim: search_aim.value,
                                        assessment: search_assessment.value,
                                        not_mail: window.sessionStorage.getItem(["mail"])
                                },
                                success: function (data) {
                                        var $content = $('#mytable');
                                        $content.empty();
                                        $content.append("<tr><th>テーマタイトル</th><th>イベントコード</th><th>プレイ日</th><th>カテゴリー</th><th>総コメント数</th></tr>");

                                        for (var i = 0; i < data.length; i++) {
                                                var add = "";
                                                add += "<tr><td><a href='#!' onclick='theme_detail(" + data[i].id + "|" + data[i].code + ")' class='square_btn'>" + data[i].title + "</a>";
                                                add += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                                                add += "<td>" + data[i].code + "</td>";
                                                add += "<td>" + data[i].play_day + "</td>";
                                                add += "<td>" + data[i].category + "</td>";
                                                add += "<td>" + data[i].comment_sum + "</td></tr>";
                                                $content.append(add);
                                        }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        $('#mytable').empty();
                                        $('#mytable').append("データがありません");
                                        document.getElementById("get_theme_button").style.display = "none";
                                        // alert('エラーです！'); //エラーを表示
                                }
                        });


                        var get = document.forms.search;
                        // console.log(search.search_title);
                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/reflection.php",
                                data: {
                                        mode: now_mode,
                                        search_code: search_code.value,
                                        title: search.search_title.value,
                                        category: search_category.value,
                                        situation: search_situation.value,
                                        time: search_time.value,
                                        area: search_area.value,
                                        target: search_target.value,
                                        aim: search_aim.value,
                                        assessment: search_assessment.value,
                                        mail: window.sessionStorage.getItem(["mail"])
                                },
                                success: function (data) {
                                        var $content1 = $('#everyone_table');
                                        $content1.empty();
                                        $content1.append("<tr><th>テーマタイトル</th><th>イベントコード</th><th>プレイ日</th><th>カテゴリー</th><th>総コメント数</th></tr>");

                                        for (var i = 0; i < data.length; i++) {
                                                var add = "";
                                                add += "<tr><td><a href='#!' onclick='theme_detail(\"" + data[i].id + "|" + data[i].code + "\")' class='square_btn'>" + data[i].title + "</a>";
                                                add += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                                                add += "<td>" + data[i].code + "</td>";
                                                add += "<td>" + data[i].play_day + "</td>";
                                                add += "<td>" + data[i].category + "</td>";
                                                add += "<td>" + data[i].comment_sum + "</td></tr>";
                                                $content1.append(add);
                                        }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        $('#everyone_table').empty();
                                        $('#everyone_table').append("データがありません");
                                        document.getElementById("get_theme_button1").style.display = "none";

                                        // alert('エラーです！'); //エラーを表示
                                }
                        });
                }

                //テーマの詳細を表示
                function theme_detail(h) {
                        h = h.split("|");
                        var decide_id = h[0];
                        reflection_eventcode = h[1];
                        get_history(h[1]);
                        eventcode = h[1];
                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/theme.php",
                                data: {
                                        id: decide_id
                                },
                                success: function (data) {
                                        // タイトル
                                        $("#title_text").empty();
                                        $("#title_text").append(data[0].title);
                                        // カテゴリー
                                        $("#category_text").empty();
                                        $("#category_text").append(data[0].category);

                                        //状況
                                        $("#situation_text").empty();
                                        $("#situation_text").append(data[0].situation);
                                        // 評価項目
                                        $("#assessment_text").empty();
                                        $("#assessment_text").append(data[0].assessment0);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment1);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment2);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment3);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment4);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment5);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment6);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment7);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment8);
                                        $("#assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment9);
                                        // 日時・時期
                                        $("#time_text").empty();
                                        $("#time_text").append(data[0].time);

                                        // 地域
                                        $("#area_text").empty();
                                        $("#area_text").append(data[0].area);

                                        // 画像
                                        $("#image_text").empty();
                                        // $("#image_text").append(data[0].image);
                                        if (data[0].image != "" && data[0].image != null)
                                                $("#image_text").append('<img src="http://192.168.0.159/2018grade4/HUG/HUG_Server/image/' + data[0].id + '.jpeg">');

                                        // 対象者
                                        $("#target_text").empty();
                                        $("#target_text").append(data[0].target);

                                        // ねらい
                                        $("#aim_text").empty();
                                        $("#aim_text").append(data[0].aim);

                                        //作成者
                                        $("#name_text").empty();
                                        $("#name_text").append(data[0].name);

                                        // 公開の可否
                                        $("#open_text").empty();
                                        $("#open_text").append(data[0].open);

                                        //**********************************************************************************
                                        // タイトル
                                        $("#theme_title_text").empty();
                                        $("#theme_title_text").append(data[0].title);
                                        // カテゴリー
                                        $("#theme_category_text").empty();
                                        $("#theme_category_text").append(data[0].category);
                                        //状況
                                        $("#theme_situation_text").empty();
                                        $("#theme_situation_text").append(data[0].situation);
                                        // 評価項目
                                        $("#theme_assessment_text").empty();
                                        $("#theme_assessment_text").append(data[0].assessment0);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment1);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment2);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment3);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment4);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment5);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment6);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment7);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment8);
                                        $("#theme_assessment_text").append("&nbsp;&nbsp;&nbsp;&nbsp;" + data[0].assessment9);
                                        // 日時・時期
                                        $("#theme_time_text").empty();
                                        $("#theme_time_text").append(data[0].time);
                                        // 地域
                                        $("#theme_area_text").empty();
                                        $("#theme_area_text").append(data[0].area);
                                        // 対象者
                                        $("#theme_target_text").empty();
                                        $("#theme_target_text").append(data[0].target);
                                        // ねらい
                                        $("#theme_aim_text").empty();
                                        $("#theme_aim_text").append(data[0].aim);
                                        // 公開の可否
                                        $("#theme_open_text").empty();
                                        $("#theme_open_text").append(data[0].open);
                                        // 画像
                                        $("#theme_image_text").empty();
                                        // $("#image_text").append(data[0].image);
                                        if (data[0].image != "" && data[0].image != null) {
                                                $("#theme_image_text").append('<img id="aaa" src="http://192.168.0.159/2018grade4/HUG/HUG_Server/image/' + data[0].image + '">');
                                                $('canvas').css('background', 'url(http://192.168.0.159/2018grade4/HUG/HUG_Server/image/' + data[0].image + ')');
                                                $('canvas').css('background-size', '100% 100%');
                                        }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        // alert('エラーです！'); //エラーを表示
                                }
                        });

                        //ボタンや表の表示・非表示の切り替え
                        document.getElementById("get_theme_button").style.display = "none";
                        document.getElementById("back_button").style.display = "";
                        document.getElementById("table").style.display = "none";
                        document.getElementById("detail").style.display = "";
                }

                //履歴上にある画像の表示
                function exchange_history_image_view(image_id) {
                        document.getElementById(image_id + "_view_all").style.display = "none";
                        document.getElementById(image_id + "_not_view").style.display = "";
                        document.getElementById(image_id).style.display = "";
                }

                //履歴上にある画像の非表を切り替え
                function exchange_history_image_not_view(image_id) {
                        document.getElementById(image_id).style.display = "none";
                        document.getElementById(image_id + "_view_all").style.display = "";
                        document.getElementById(image_id + "_not_view").style.display = "none";
                }

                function overview(h, n) {
                        if (h == "on") {
                                document.getElementById("black_box").style.display = "";
                                if (n == "1")
                                        document.getElementById("theme_detail_box").style.display = "";
                                else if (n == "2")
                                        document.getElementById("overview_detail_box").style.display = "";
                                else if (n == "3")
                                        document.getElementById("situation_detail_box").style.display = "";
                                else if (n == "4")
                                        document.getElementById("history_image_detail_box").style.display = "";
                                else if (n == "5")
                                        document.getElementById("trace_box").style.display = "";

                        } else if (h == "off") {
                                document.getElementById("black_box").style.display = "none";
                                document.getElementById("theme_detail_box").style.display = "none";
                                // document.getElementById("overview_detail_box").style.display = "none";
                                // document.getElementById("situation_detail_box").style.display = "none";
                                // document.getElementById("history_image_detail_box").style.display = "none";
                                document.getElementById("trace_box").style.display = "none";

                        }

                }

                var comment_num = -1;
                function comment_start(num) {
                        comment_num = num;
                        document.getElementById("comment_input").style.display = "";
                        document.getElementById("comment_confirm").style.display = "none";
                        document.getElementById("comment_view").style.display = "none";

                }

                function next_comment() {
                        document.getElementById("comment_input").style.display = "none";
                        document.getElementById("comment_confirm").style.display = "";
                        document.getElementById("comment_view").style.display = "none";

                        $("#comment_confirm_text").empty();
                        $("#comment_confirm_text").append(document.getElementById("comment_input_text").value)
                }
                function decide_comment() {
                        document.getElementById("comment_input").style.display = "";
                        document.getElementById("comment_confirm").style.display = "none";
                        document.getElementById("comment_view").style.display = "none";

                        $.ajax({ //振り返りコメント登録
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        data1: document.getElementById("comment_input_text").value,
                                        data2: comment_num,
                                        code: reflection_eventcode,
                                        mode: "insert",
                                        id: 7
                                },
                                success: function (data) {
                                        stop_comment();
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        console.log("コメント登録エラー");
                                        console.log("XMLHttpRequest::" + XMLHttpRequest);
                                        console.log("textStatus::" + textStatus);
                                        console.log("errorThrown::" + errorThrown);
                                }
                        });
                }

                function stop_comment() {
                        comment_num = -1;
                        document.getElementById("comment_input").style.display = "none";
                        document.getElementById("comment_confirm").style.display = "none";
                        $("#comment_confirm_text").empty();
                        document.getElementById("comment_input_text").value = "";
                        document.getElementById("comment_view").style.display = "none";
                }

                function comment_view(num) {
                        document.getElementById("comment_input").style.display = "none";
                        document.getElementById("comment_confirm").style.display = "none";
                        $.ajax({ //振り返りコメント登録
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        code: reflection_eventcode,
                                        id: 7
                                },
                                success: function (data) {
                                        $("#comment_view").empty();
                                        // console.log(data);
                                        var add = "", class_name, color;
                                        class_name = "block1";
                                        color = "#e0ffff";
                                        //全ての履歴
                                        for (var i = data.length - 1; i > -1; i--) {
                                                if (data[i].data2 == num) {
                                                        if (i != data.length - 1)
                                                                add = "<div class='" + class_name + "' style='width:90%;left:4%;font-size: 13px;border:1px solid green;border-top:0px solid green;background: " + color + ";'>";
                                                        else
                                                                add = "<div class='" + class_name + "' style='width:90%;left:4%;font-size: 13px;border:1px solid green;background: " + color + ";'>";
                                                        add += set_history_data(data[i], "comment");
                                                        add += "</div> ";
                                                        $("#comment_view").append(add);
                                                }
                                        }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        console.log("コメント登録エラー");
                                        console.log("XMLHttpRequest::" + XMLHttpRequest);
                                        console.log("textStatus::" + textStatus);
                                        console.log("errorThrown::" + errorThrown);
                                }
                        });
                }
        </script>
</body>

</html>