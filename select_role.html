<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>ログイン</title>
    <script src="https://code.jquery.com/jquery-1.9.0.min.js"></script>

    <style type="text/css">
        canvas {
            /* background: rgb(255, 255, 255); */
            background: url(image.jpeg);
            background-size: cover;
            border: 1px solid #999;
            position: absolute;
            top: 32px;
            left: 8px;

        }

        div {
            background: #e6f1fa;
            width: 300px;
            padding: 10px;
            /* text-align: center; */
            border: 1px solid #cccccc;
            margin: 30px auto;
            font-size: 20px;

        }
    </style>

</head>

<body onload="init();">
    <input type="button" value="送信" onclick="send()">
    <!-- <input type="button" value="受信" onclick="recieve()"> -->
    <input type="button" value="四角" onclick="create_rect()">

    <br>
    <canvas id="canvas" width="400" height="400"></canvas>
    <!-- <img src="image.jpeg"> -->
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>

    <!-- <center> -->
    <div>
        <form id="create_figure">
            図形の色
            <input type="color" name="figure_color" list="color_list" value="#00ff00">
            <br> ラベル名
            <input type="text" name="label_name" id="label_name" required>
            <br>ラベルの色
            <input type="color" name="label_color" list="color_list" value="#ff0000">


            <input type="button" value="決定" onclick="create_rect()">
        </form>
    </div>
    <!-- </center> -->
    <datalist id="color_list">
        <option value="#ff0000">#ff0000</option>
        <option value="#00ff00">#00ff00</option>
        <option value="#0000ff">#0000ff</option>
    </datalist>

    <user_info></user_info>


    <br>ID

    <script>
        var debug = 1;
        if (debug == 0)
            var mynumber = sessionStorage.getItem('mynumber') - 1;
        else
            mynumber = 1;
        document.write(mynumber);
        var ev;
        var figure_info = [];
        var canvas = document.getElementById("canvas");
        var size_change_marker = {
            place: {
                x: -1,
                y: -1,
                width: 8,
                height: 8
            },
            color: "blue",
            ctx: canvas.getContext("2d")
        };
        var rectx = 0, recty = 0;
        var myedit = 0;
        var mousex = 0, mousey = 0;
        var imag_mousex;
        var imag_mousey;
        var FIGURE = {
            NULL: 0,
            MOVE: 1,
            CHANGE: 2,
        };
        var TYPE = {
            RECT: 0
        };
        var change_flag = 0;

        //四角形クラス
        function rect(id, type, place, stats, color, label_color, label_text, ctx, ctx_label) {
            this.id = id;
            this.type = type;
            this.place = place
            this.stats = stats;
            this.color = color;
            this.label_color = label_color;
            this.label_text = label_text;
            this.ctx = ctx;
            this.ctx_label = ctx_label
        }

        function init() {
            setInterval(draw, 100);
            // get_user_info();
            create_rect();
            draw_figure();
            // console.log(figure_info[0]);
        }

        function create_rect() {
            var place = [20, 20, 100, 100];
            var ctx = canvas.getContext("2d");
            ctx.globalAlpha = 0.6;
            var ctx_label = canvas.getContext("2d");
            // ctx_label.globalAlpha = 0.6;
            var get = document.forms[0];

            var get_color = get.figure_color.value;
            var r = parseInt(get_color.substr(1, 2), 16).toString(10);
            var g = parseInt(get_color.substr(3, 2), 16).toString(10);
            var b = parseInt(get_color.substr(5, 2), 16).toString(10);

            // console.log(get_color + "::" + r + "," + g + "," + b);
            var color = "rgb(" + r + "," + g + "," + b + ")";

            get_color = get.label_color.value;
            r = parseInt(get_color.substr(1, 2), 16).toString(10);
            g = parseInt(get_color.substr(3, 2), 16).toString(10);
            b = parseInt(get_color.substr(5, 2), 16).toString(10);
            var label_color = "rgb(" + r + "," + g + "," + b + ")";
            figure_info.push(new rect(0, TYPE.RECT, place, FIGURE.NULL, color, label_color, get.label_name.value, ctx, ctx_label));
        }


        function handleMouseMove(e) {
            event = e; // IE対応
            ev = event;
            mousex = event.clientX;
            mousey = event.clientY;
            imag_mousex = mousex - canvas.getBoundingClientRect().left;
            imag_mousey = mousey - canvas.getBoundingClientRect().top;

            if (myedit != -1)
                size_change_marker_move();

        }

        function draw_figure() {

            for (var i = 0; i < figure_info.length; i++) {
                var place = figure_info[i].place;
                figure_info[i].ctx.fillStyle = figure_info[i].color;
                figure_info[i].ctx.fillRect(place[0], place[1], place[2], place[3]);
                figure_info[i].ctx_label.fillStyle = figure_info[i].label_color;
                var label_place = [place[0] + place[2] * 0.1, place[1] + place[2] * 0.1, place[2] * 0.8, place[3] * 0.3];
                figure_info[i].ctx_label.fillRect(label_place[0], label_place[1], label_place[2], label_place[3]);
                figure_info[i].ctx_label.textBaseline = "top";
                figure_info[i].ctx_label.font = "15px 'ＭＳ ゴシック'";
                figure_info[i].ctx_label.fillStyle = "black";
                figure_info[i].ctx_label.fillText(figure_info[i].label_name, label_place[0], label_place[1]);
            }
            size_change_marker.ctx.fillStyle = size_change_marker.color;
            size_change_marker.ctx.fillRect(size_change_marker.place.x, size_change_marker.place.y, size_change_marker.place.width, size_change_marker.place.height);

        }

        function clear_figure() {

            size_change_marker.ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function draw() {
            // console.log(mousex + "::" + mousey + "::::::" + figure[mynumber][0] + "~" + (figure[mynumber][0] + x1) + "::" + figure[mynumber][1] + "~" + (figure[mynumber][1] + y1));
            // console.log(size_change_marker);
            window.onmousemove = handleMouseMove;
            if (debug == 0)
                recieve();
            clear_figure();
            if (myedit != -1)
                switch (figure_info[myedit].stats) {
                    case FIGURE.MOVE:
                        figure_info[myedit].place[0] = mousex - canvas.getBoundingClientRect().left - rectx;
                        figure_info[myedit].place[1] = mousey - canvas.getBoundingClientRect().top - recty;
                        break;
                    case FIGURE.CHANGE:
                        size_change();
                        break;
                    // case FIGURE.CHANGE_X:

                    //     break;
                    // case FIGURE.CHANGE_Y:

                    //     break;
                    // case FIGURE.CHANGE_XY:

                    //     break;

                }

            draw_figure();
            // size_change_flag();

        }

        document.onmousedown = function (e) {
            if (!e) e = window.event; // レガシー

            //myeditに値格納
            for (var i = 0; i < figure_info.length; i++)
                if (place_judge(figure_info[i].place[0], figure_info[i].place[2], figure_info[i].place[1], figure_info[i].place[3], imag_mousex, imag_mousey))
                    myedit = i;
            if (myedit != -1)
                if (size_change_flag() == 1)
                    figure_info[myedit].stats = FIGURE.CHANGE;
                else {
                    rectx = imag_mousex - figure_info[myedit].place[0];
                    recty = imag_mousey - figure_info[myedit].place[1];
                    clear_figure();
                    figure_info[myedit].place[0] = mousex - canvas.getBoundingClientRect().left - rectx;
                    figure_info[myedit].place[1] = mousey - canvas.getBoundingClientRect().top - recty;

                    figure_info[myedit].stats = FIGURE.MOVE;
                    draw_figure();
                }
        }


        window.onmouseup = function (e) {
            // console.log("離された");
            if (myedit != -1)
                figure_info[myedit].stats = FIGURE.NULL;
            // myedit = -1;
            change_flag = 0;
        }

        function get_user_info() {
            $.ajax({
                type: "POST",
                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/read_user.php",
                dataType: "json",
            }).done(function (data, dataType) {
                // successのブロック内は、Ajax通信が成功した場合に呼び出される

                // 結果が0件の場合
                // if (userdata == null) alert('データが0件でした');

                for (var i = 0; i < data.length; i++) {
                    $("user_info").append("name : " + data[i].name + "&nbsp;" + data[i].role + "<br>");
                }
            }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                // alert('Error : ' + errorThrown);
            });
        }

        function recieve() {
            $.ajax({
                type: "POST",
                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/read_share.php",
                dataType: "json",
            }).done(function (data, dataType) {
                // successのブロック内は、Ajax通信が成功した場合に呼び出される

                // 結果が0件の場合
                // if (userdata == null) alert('データが0件でした');

                for (var i = 0; i < data.length; i++) {
                    // if (data[i].number - 1 != mynumber) {
                    //     figure[data[i].number - 1][0] = data[i].data1;
                    //     figure[data[i].number - 1][1] = data[i].data2;
                    //     figure[data[i].number - 1][2] = data[i].data3;
                    //     figure[data[i].number - 1][3] = data[i].data4;

                    // }

                    //色とIDとラベル関係***********************************************************
                    var place = [data[i].data1, data[i].data2, data[i].data3, data[i].data4];
                    figure_info.push(new rect(0, TYPE.RECT, place, FIGURE.NULL, "green", "red", "ラベル", canvas.getContext("2d")));

                }
            }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                // alert('Error : ' + errorThrown);
            });
            clear_figure();
            draw_figure();
        }

        function send() {
            $.ajax({ //ajaxによる非同期通信発生
                type: "POST", //POST送信でデータを受け渡す
                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/share_insert.php",
                data: {
                    //色々変える必要あり***********************************************************
                    info_id: 1,
                    number: sessionStorage.getItem('mynumber'),
                    data1: figure[mynumber][0],
                    data2: figure[mynumber][1],
                    data3: figure[mynumber][2],
                    data4: figure[mynumber][3]
                },
                success: function (hoge) { //接続が成功
                    // alert(hoge);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                    // alert(errorThrown); //エラーを表示
                }
            });
            return false;
        }


        function place_judge(x, x_range, y, y_range, plascex, placey) {
            if (x < plascex && x + x_range > plascex && y < placey && y + y_range > placey) {
                return true;
            }
            return false;
        }

        function size_change_marker_move() {
            var range = 4;
            size_change_marker.place.x = -10;
            size_change_marker.place.y = -10;
            var cnt = 0;

            if (place_judge(figure_info[myedit].place[0] - range, range * 2, figure_info[myedit].place[1] - range, figure_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = figure_info[myedit].place[0] - range;
                size_change_marker.place.y = imag_mousey;
                cnt++;
            }
            if (place_judge(figure_info[myedit].place[0] + figure_info[myedit].place[2] - range, range * 2, figure_info[myedit].place[1] - range, figure_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = figure_info[myedit].place[0] + figure_info[myedit].place[2] - range;
                size_change_marker.place.y = imag_mousey;
                cnt++;
            }
            if (place_judge(figure_info[myedit].place[0] - range, figure_info[myedit].place[2] + range, figure_info[myedit].place[1] - range, range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = imag_mousex;
                size_change_marker.place.y = figure_info[myedit].place[1] - range;
                cnt++;
            }
            if (place_judge(figure_info[myedit].place[0] - range, figure_info[myedit].place[2] + range, figure_info[myedit].place[1] + figure_info[myedit].place[3] - range, range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = imag_mousex;
                size_change_marker.place.y = figure_info[myedit].place[1] + figure_info[myedit].place[3] - range;
                cnt++;
            }
            if (cnt > 1)
                size_change_marker.color = "red";
            else
                size_change_marker.color = "blue";
        }
        function size_change_flag() {
            var range = 4;

            if (place_judge(figure_info[myedit].place[0] - range, range * 2, figure_info[myedit].place[1] - range, figure_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                figure_info[myedit].stats = FIGURE.CHANGE;
                change_flag += 1;
            }
            if (place_judge(figure_info[myedit].place[0] + figure_info[myedit].place[2] - range, range * 2, figure_info[myedit].place[1] - range, figure_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                figure_info[myedit].stats = FIGURE.CHANGE;
                change_flag += 2;
            }
            if (place_judge(figure_info[myedit].place[0] - range, figure_info[myedit].place[2] + range, figure_info[myedit].place[1] - range, range * 2, imag_mousex, imag_mousey)) {
                figure_info[myedit].stats = FIGURE.CHANGE;
                change_flag += 10;
            }
            if (place_judge(figure_info[myedit].place[0] - range, figure_info[myedit].place[2] + range, figure_info[myedit].place[1] + figure_info[myedit].place[3] - range, range * 2, imag_mousex, imag_mousey)) {
                figure_info[myedit].stats = FIGURE.CHANGE;
                change_flag += 20;
            }

            if (change_flag != 0)
                return 1;
            return 0;
        }

        function size_change() {



            console.log(Math.floor(change_flag % 10));
            if (change_flag % 10 == 1) {
                figure_info[myedit].place[2] += figure_info[myedit].place[0] - imag_mousex;
                figure_info[myedit].place[0] = imag_mousex;
            }
            else if (change_flag % 10 == 2) {
                figure_info[myedit].place[2] = imag_mousex - figure_info[myedit].place[0];
            }
            if (Math.floor(change_flag / 10) == 1) {
                figure_info[myedit].place[3] += figure_info[myedit].place[1] - imag_mousey;
                figure_info[myedit].place[1] = imag_mousey;
            }
            else if (Math.floor(change_flag / 10) == 2) {
                figure_info[myedit].place[3] = imag_mousey - figure_info[myedit].place[1];
            }




        }



    </script>
</body>

</html>