<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>ログイン</title>
    <script src="https://code.jquery.com/jquery-1.9.0.min.js"></script>

    <style type="text/css">
        canvas {
            /* background: rgb(255, 255, 255); */
            background: url(image.jpeg);
            background-size: cover;
            border: 1px solid #999;
            position: absolute;
            top: 32px;
            left: 8px;

        }
    </style>

</head>

<body onload="init();">
    <input type="button" value="送信" onclick="send()">
    <!-- <input type="button" value="受信" onclick="recieve()"> -->
    <input type="button" value="四角" onclick="create_rect()">

    <br>
    <canvas id="canvas" width="400" height="400"></canvas>
    <!-- <img src="image.jpeg"> -->
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <user_info></user_info>


    <br>ID

    <script>
        var debug = 1;
        if (debug == 0)
            var mynumber = sessionStorage.getItem('mynumber') - 1;
        else
            mynumber = 1;
        document.write(mynumber);
        var ev;
        var zukei_info = [];
        var canvas = document.getElementById("canvas");
        var size_change_marker = {
            place: {
                x: -1,
                y: -1,
                width: 8,
                height: 8
            },
            color: "blue",
            ctx: canvas.getContext("2d")
        };
        var rectx = 0, recty = 0;
        var myedit = 0;
        var mousex = 0, mousey = 0;
        var imag_mousex;
        var imag_mousey;
        var ZUKEI = {
            NULL: 0,
            MOVE: 1,
            CHANGE: 2,
        };
        var TYPE = {
            RECT: 0
        };
        var change_flag = 0;

        //四角形クラス
        function rect(id, type, place, stats, color, label_color, label_text, ctx) {
            this.id = id;
            this.type = type;
            this.place = place
            this.stats = stats;
            this.color = color;
            this.label_color = label_color;
            this.label_text = label_text;
            this.ctx = ctx;
        }

        function init() {
            setInterval(draw, 100);
            // get_user_info();
            create_rect();
            draw_zukei();
            // console.log(zukei_info[0]);
        }

        function create_rect() {
            var place = [20, 20, 100, 100];
            var ctx = canvas.getContext("2d");
            ctx.globalAlpha = 0.6;

            zukei_info.push(new rect(0, TYPE.RECT, place, ZUKEI.NULL, "green", "red", "ラベル", ctx));
        }


        function handleMouseMove(e) {
            event = e; // IE対応
            ev = event;
            mousex = event.clientX;
            mousey = event.clientY;
            imag_mousex = mousex - canvas.getBoundingClientRect().left;
            imag_mousey = mousey - canvas.getBoundingClientRect().top;

            if (myedit != -1)
                size_change_marker_move();

        }

        function draw_zukei() {

            for (var i = 0; i < zukei_info.length; i++) {
                // if (i == mynumber)
                zukei_info[i].ctx.fillStyle = zukei_info[i].color;
                // else
                //     ctx[i].fillStyle = "blue";
                var place = zukei_info[i].place;
                zukei_info[i].ctx.fillRect(place[0], place[1], place[2], place[3]);

            }
            size_change_marker.ctx.fillStyle = size_change_marker.color;
            size_change_marker.ctx.fillRect(size_change_marker.place.x, size_change_marker.place.y, size_change_marker.place.width, size_change_marker.place.height);

        }
        function clear_zukei() {
            // for (var i = 0; i < 2; i++) {
            //     ctx[i].clearRect(0, 0, canvas.width, canvas.height);
            // }

            //***********************************************************

            size_change_marker.ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function draw() {
            // console.log(mousex + "::" + mousey + "::::::" + zukei[mynumber][0] + "~" + (zukei[mynumber][0] + x1) + "::" + zukei[mynumber][1] + "~" + (zukei[mynumber][1] + y1));
            // console.log(size_change_marker);
            window.onmousemove = handleMouseMove;
            if (debug == 0)
                recieve();
            clear_zukei();
            if (myedit != -1)
                switch (zukei_info[myedit].stats) {
                    case ZUKEI.MOVE:
                        zukei_info[myedit].place[0] = mousex - canvas.getBoundingClientRect().left - rectx;
                        zukei_info[myedit].place[1] = mousey - canvas.getBoundingClientRect().top - recty;
                        break;
                    case ZUKEI.CHANGE:
                        size_change();
                        break;
                    // case ZUKEI.CHANGE_X:

                    //     break;
                    // case ZUKEI.CHANGE_Y:

                    //     break;
                    // case ZUKEI.CHANGE_XY:

                    //     break;

                }

            draw_zukei();
            // size_change_flag();

        }

        document.onmousedown = function (e) {
            if (!e) e = window.event; // レガシー

            //myeditに値格納
            for (var i = 0; i < zukei_info.length; i++)
                if (place_judge(zukei_info[i].place[0], zukei_info[i].place[2], zukei_info[i].place[1], zukei_info[i].place[3], imag_mousex, imag_mousey))
                    myedit = i;
            if (myedit != -1)
                if (size_change_flag() == 1)
                    zukei_info[myedit].stats = ZUKEI.CHANGE;
                else {
                    rectx = imag_mousex - zukei_info[myedit].place[0];
                    recty = imag_mousey - zukei_info[myedit].place[1];
                    clear_zukei();
                    zukei_info[myedit].place[0] = mousex - canvas.getBoundingClientRect().left - rectx;
                    zukei_info[myedit].place[1] = mousey - canvas.getBoundingClientRect().top - recty;

                    zukei_info[myedit].stats = ZUKEI.MOVE;
                    draw_zukei();
                }
        }


        window.onmouseup = function (e) {
            // console.log("離された");
            if (myedit != -1)
                zukei_info[myedit].stats = ZUKEI.NULL;
            myedit = -1;
            change_flag = 0;
        }

        function get_user_info() {
            $.ajax({
                type: "POST",
                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/read_user.php",
                dataType: "json",
            }).done(function (data, dataType) {
                // successのブロック内は、Ajax通信が成功した場合に呼び出される

                // 結果が0件の場合
                // if (userdata == null) alert('データが0件でした');

                for (var i = 0; i < data.length; i++) {
                    $("user_info").append("name : " + data[i].name + "&nbsp;" + data[i].role + "<br>");
                }
            }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                // alert('Error : ' + errorThrown);
            });
        }

        function recieve() {
            $.ajax({
                type: "POST",
                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/read_share.php",
                dataType: "json",
            }).done(function (data, dataType) {
                // successのブロック内は、Ajax通信が成功した場合に呼び出される

                // 結果が0件の場合
                // if (userdata == null) alert('データが0件でした');

                for (var i = 0; i < data.length; i++) {
                    // if (data[i].number - 1 != mynumber) {
                    //     zukei[data[i].number - 1][0] = data[i].data1;
                    //     zukei[data[i].number - 1][1] = data[i].data2;
                    //     zukei[data[i].number - 1][2] = data[i].data3;
                    //     zukei[data[i].number - 1][3] = data[i].data4;

                    // }

                    //色とIDとラベル関係***********************************************************
                    var place = [data[i].data1, data[i].data2, data[i].data3, data[i].data4];
                    zukei_info.push(new rect(0, TYPE.RECT, place, ZUKEI.NULL, "green", "red", "ラベル", canvas.getContext("2d")));

                }
            }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                // alert('Error : ' + errorThrown);
            });
            clear_zukei();
            draw_zukei();
        }

        function send() {
            $.ajax({ //ajaxによる非同期通信発生
                type: "POST", //POST送信でデータを受け渡す
                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/share_insert.php",
                data: {
                    //色々変える必要あり***********************************************************
                    info_id: 1,
                    number: sessionStorage.getItem('mynumber'),
                    data1: zukei[mynumber][0],
                    data2: zukei[mynumber][1],
                    data3: zukei[mynumber][2],
                    data4: zukei[mynumber][3]
                },
                success: function (hoge) { //接続が成功
                    // alert(hoge);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                    // alert(errorThrown); //エラーを表示
                }
            });
            return false;
        }


        function place_judge(x, x_range, y, y_range, plascex, placey) {
            if (x < plascex && x + x_range > plascex && y < placey && y + y_range > placey) {
                return true;
            }
            return false;
        }

        function size_change_marker_move() {
            var range = 4;
            size_change_marker.place.x = -10;
            size_change_marker.place.y = -10;
            var cnt = 0;

            if (place_judge(zukei_info[myedit].place[0] - range, range * 2, zukei_info[myedit].place[1] - range, zukei_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = zukei_info[myedit].place[0] - range;
                size_change_marker.place.y = imag_mousey;
                cnt++;
            }
            if (place_judge(zukei_info[myedit].place[0] + zukei_info[myedit].place[2] - range, range * 2, zukei_info[myedit].place[1] - range, zukei_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = zukei_info[myedit].place[0] + zukei_info[myedit].place[2] - range;
                size_change_marker.place.y = imag_mousey;
                cnt++;
            }
            if (place_judge(zukei_info[myedit].place[0] - range, zukei_info[myedit].place[2] + range, zukei_info[myedit].place[1] - range, range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = imag_mousex;
                size_change_marker.place.y = zukei_info[myedit].place[1] - range;
                cnt++;
            }
            if (place_judge(zukei_info[myedit].place[0] - range, zukei_info[myedit].place[2] + range, zukei_info[myedit].place[1] + zukei_info[myedit].place[3] - range, range * 2, imag_mousex, imag_mousey)) {
                size_change_marker.place.x = imag_mousex;
                size_change_marker.place.y = zukei_info[myedit].place[1] + zukei_info[myedit].place[3] - range;
                cnt++;
            }
            if (cnt > 1)
                size_change_marker.color = "red";
            else
                size_change_marker.color = "blue";
        }
        function size_change_flag() {
            var range = 4;

            if (place_judge(zukei_info[myedit].place[0] - range, range * 2, zukei_info[myedit].place[1] - range, zukei_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                zukei_info[myedit].stats = ZUKEI.CHANGE;
                change_flag += 1;
            }
            if (place_judge(zukei_info[myedit].place[0] + zukei_info[myedit].place[2] - range, range * 2, zukei_info[myedit].place[1] - range, zukei_info[myedit].place[3] + range * 2, imag_mousex, imag_mousey)) {
                zukei_info[myedit].stats = ZUKEI.CHANGE;
                change_flag += 2;
            }
            if (place_judge(zukei_info[myedit].place[0] - range, zukei_info[myedit].place[2] + range, zukei_info[myedit].place[1] - range, range * 2, imag_mousex, imag_mousey)) {
                zukei_info[myedit].stats = ZUKEI.CHANGE;
                change_flag += 10;
            }
            if (place_judge(zukei_info[myedit].place[0] - range, zukei_info[myedit].place[2] + range, zukei_info[myedit].place[1] + zukei_info[myedit].place[3] - range, range * 2, imag_mousex, imag_mousey)) {
                zukei_info[myedit].stats = ZUKEI.CHANGE;
                change_flag += 20;
            }

            if (change_flag != 0)
                return 1;
            return 0;
        }

        function size_change() {



            console.log(Math.floor(change_flag % 10));
            if (change_flag % 10 == 1) {
                zukei_info[myedit].place[2] += zukei_info[myedit].place[0] - imag_mousex;
                zukei_info[myedit].place[0] = imag_mousex;
            }
            else if (change_flag % 10 == 2) {
                zukei_info[myedit].place[2] = imag_mousex - zukei_info[myedit].place[0];
            }
            if (Math.floor(change_flag / 10) == 1) {
                zukei_info[myedit].place[3] += zukei_info[myedit].place[1] - imag_mousey;
                zukei_info[myedit].place[1] = imag_mousey;
            }
            else if (Math.floor(change_flag / 10) == 2) {
                zukei_info[myedit].place[3] = imag_mousey - zukei_info[myedit].place[1];
            }




        }



    </script>
</body>

</html>