<!DOCTYPE html>
<html>

<head>
        <meta charset="UTF-8" />
        <title>プレイ画面</title>
        <link rel="stylesheet" type="text/css" href="play.css">
        <script type="text/javascript" src="define.js"> </script>
        <script src="https://code.jquery.com/jquery-1.9.0.min.js"></script>
        <script type="text/javascript" src="jquery.balloon.js"></script>
        <script type="text/javascript" src="play_common.js"></script>
        <script>


                $('texi_and_pop').balloon();//マウスオーバーの割り当て

                var assessment_data = [];
                //受信
                $(document).ready(function () {
                        window.sessionStorage.setItem(["eventcode"], "5SrgaP0MjG");
                        get_theme_detail();

                        var list = '<option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>';

                        if (DEBUG)
                                $.ajax({ //非同期通信
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                        data: {
                                                code: window.sessionStorage.getItem(["eventcode"])
                                        },
                                        success: function (data1) {
                                                // alert(data1);
                                                $.ajax({ //非同期通信
                                                        type: "POST",
                                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/theme.php",
                                                        data: {
                                                                id: data1
                                                        },
                                                        success: function (data) {
                                                                var text1 = '<br><a style="position: relative;left: 140px;">';
                                                                var text2 = '：</a><select id="assessment_list';
                                                                var text3 = '" style="position: relative;width: 50px;left: 158px;">';

                                                                var add = "";
                                                                add += '<a style="position: relative;left: 40px;">' + data[0].assessment0 + '：</a>';
                                                                add += '<select id="assessment_list' + 0 + '" style="position: relative;width: 50px;left: 60px;">';
                                                                $("#assessment_list").append(add + list);
                                                                assessment_data.push(data[0].assessment0);
                                                                if (data[0].assessment1 != "") { $("#assessment_list").append(text1 + data[0].assessment1 + text2 + 1 + text3 + list); assessment_data.push(data[0].assessment1); }
                                                                if (data[0].assessment2 != "") { $("#assessment_list").append(text1 + data[0].assessment2 + text2 + 2 + text3 + list); assessment_data.push(data[0].assessment2); }
                                                                if (data[0].assessment3 != "") { $("#assessment_list").append(text1 + data[0].assessment3 + text2 + 3 + text3 + list); assessment_data.push(data[0].assessment3); }
                                                                if (data[0].assessment4 != "") { $("#assessment_list").append(text1 + data[0].assessment4 + text2 + 4 + text3 + list); assessment_data.push(data[0].assessment4); }
                                                                if (data[0].assessment5 != "") { $("#assessment_list").append(text1 + data[0].assessment5 + text2 + 5 + text3 + list); assessment_data.push(data[0].assessment5); }
                                                                if (data[0].assessment6 != "") { $("#assessment_list").append(text1 + data[0].assessment6 + text2 + 6 + text3 + list); assessment_data.push(data[0].assessment6); }
                                                                if (data[0].assessment7 != "") { $("#assessment_list").append(text1 + data[0].assessment7 + text2 + 7 + text3 + list); assessment_data.push(data[0].assessment7); }
                                                                if (data[0].assessment8 != "") { $("#assessment_list").append(text1 + data[0].assessment8 + text2 + 8 + text3 + list); assessment_data.push(data[0].assessment8); }
                                                                if (data[0].assessment9 != "") { $("#assessment_list").append(text1 + data[0].assessment9 + text2 + 9 + text3 + list); assessment_data.push(data[0].assessment9); }

                                                        },
                                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                                // alert('エラーです！'); //エラーを表示
                                                                console.log("えらー:" + textStatus);
                                                        }
                                                });
                                        },
                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                // alert('エラーです！'); //エラーを表示
                                        }
                                });

                        if (DEBUG)
                                get_history();
                });


                //ID指定のデータの受信
                function get_id_data(get_id) {
                        if (DEBUG)
                                $.ajax({ //非同期通信
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                        data: {
                                                code: window.sessionStorage.getItem(["eventcode"]),
                                                id: get_id
                                        },
                                        success: function (data) {
                                                return data;
                                        },
                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                // alert('エラーです！'); //エラーを表示
                                                console.log("えらー:" + textStatus);
                                        }
                                });
                        return null;
                }

        </script>
</head>

<body>
        <script>
                $(function () { $("#include_common").load("play_common.html"); })
        </script>

        <div id="include_common">
        </div>
        <!-- 新規入力画面 *************************************************************-->
        <form id="cope_input" style="display: none;">
                <div class="block1" id="situation">
                        状況*<br>
                        <draw_area id="situation_text"></draw_area>
                </div>
                <div class="block2">
                        画像
                        <div id="image_draw"></div>

                </div>
                <!-- 対応 -->
                <div class="block1">
                        <text_and_pop id="cope_input_text" title="状況への対応を記入してください" style="position: relative;top:-30px;">対応*
                                <b style="font-size: 10px;">(100字以内)</b>
                        </text_and_pop>
                        <textarea id="cope" maxlength='100' class="textarea_smoll" wrap="soft" style="position: relative; left:0px;top:-30%;"
                                required></textarea>
                </div>
                <br>
                <a style="position: relative; left:27%;">
                        <!-- ボタン -->
                        <input type="button" value="次へ" onclick='next("situation")'>
                </a>
        </form>
        <!-- 確認画面 *************************************************************-->
        <form id="confirm_cope" style="display: none;">
                <div class="block1" id="situation">
                        状況*<br>
                        <draw_area id="confirm_situation_text"></draw_area>
                </div>
                <div class="block2">
                        画像
                        <div id="image_draw"></div>

                </div>
                <!-- 対応 -->
                <div class="block1">
                        対応*<br>
                        <draw_area id="confirm_cope"></draw_area>
                </div>
                <br>
                <a style="position: relative; left:27%;">
                        <!-- ボタン -->
                        <input type="button" value="訂正" onclick='back("situation")'> &nbsp; &nbsp; &nbsp; &nbsp;
                        <input type="button" value="内容確定" onclick='decide("situation")'>
                </a>
        </form>
        <script>
                var assessment_send = [], category_send, time_send = "", image_send = "";//登録時に送信する用
                var mode = "new";//新規作成か再利用の識別変数
                //次へボタンが押された時
                function next() {
                        var required_flag = true;//入力必須事項の確認用

                         if (h == "human") {
                                var get1 = document.forms.cope_input;
                                $("#feature_text").empty();
                                $("#feature_text").append(get1.feature.value);
                                if (get1.feature.value == "") {
                                        required_flag = false;
                                        document.getElementById("feature_input_text").style.color = "red";
                                }


                                // 入力必須事項の確認
                                if (required_flag == true) {
                                        document.getElementById("required_error").style.display = "none";
                                        document.getElementById("human_card").style.display = "none";
                                        document.getElementById("confirm_human").style.display = "";
                                        document.getElementById("required_error").style.display = "none";
                                }
                                else {
                                        document.getElementById("required_error").style.display = "";
                                }
                        }
                }

                //訂正ボタンが押された
                function back(h) {
                        if (h == "situation") {
                                document.getElementById("situation_card").style.display = "";
                        }
                        else if (h == "human") {
                                document.getElementById("human_card").style.display = "";
                        }
                        document.getElementById("required_error").style.display = "";
                        document.getElementById("confirm_situation").style.display = "none";
                        document.getElementById("confirm_human").style.display = "none";
                        document.getElementById("required_error").style.display = "none";
                }

                var send_f = 1;
                //内容確定ボタンが押された
                function decide(h) {
                        if (h == "situation") {
                                var get1 = document.forms.input1;
                                var file_name = "";
                                var form = document.getElementById("file_input");
                                var a = document.getElementById("image_file");
                                alert(a.value);
                                if (a.value != "")
                                        file_name = window.sessionStorage.getItem(["eventcode"]);
                                if (send_f == 1) {
                                        send_f = 0;
                                        $.ajax({ //非同期通信
                                                type: "POST",
                                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                                data: {
                                                        data1: get1.situation.value,
                                                        data2: assessment_send.join("/"),
                                                        data3: file_name,
                                                        data4: "21:20",
                                                        code: window.sessionStorage.getItem(["eventcode"]),
                                                        mode: "insert",
                                                        id: 2
                                                },
                                                success: function (data) {
                                                        console.log(data);
                                                        alert(data);
                                                        data = data.split("/");
                                                        if (data[1] != "")
                                                                file(data[1]);
                                                        if (data[0] == "ok") {
                                                                window.location.href = "pm.html";
                                                        }
                                                        else {
                                                                alert("ok以外");
                                                        }
                                                        send_f = 1;
                                                },
                                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                        // alert('エラーです！'); //エラーを表示
                                                        send_f = 1;
                                                        console.log("えらー:" + textStatus);
                                                }
                                        });
                                }
                        }
                        else if (h == "human") {
                                if (send_f == 1) {
                                        var get2 = document.forms.input_human;

                                        send_f = 0;
                                        $.ajax({ //非同期通信
                                                type: "POST",
                                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                                data: {
                                                        data1: get2.feature.value,
                                                        data2: get2.age.value,
                                                        data3: get2.sex.value,
                                                        data4: "21:20",
                                                        code: window.sessionStorage.getItem(["eventcode"]),
                                                        mode: "insert",
                                                        id: 3
                                                },
                                                success: function (data) {
                                                        if (data == "ok") {
                                                                // window.location.href = "pm.html";
                                                                exchange_mode("new");
                                                        }
                                                        else {
                                                                alert("ok以外");
                                                        }
                                                        send_f = 1;
                                                },
                                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                        // alert('エラーです！'); //エラーを表示
                                                        console.log("えらー:" + textStatus);
                                                        send_f = 1;
                                                }
                                        });
                                }
                        }
                }
                function file(num) {
                        var form = document.getElementById("file_input");
                        var formdata = new FormData(form);
                        // console.log();
                        // if (form != "")
                        $.ajax({
                                type: 'POST',
                                url: 'http://192.168.0.159/2018grade4/HUG/HUG_Server/file_upload.php?code=' + window.sessionStorage.getItem(["eventcode"]) + '&&num=' + num,
                                data: formdata,
                                processData: false,	// jQueryがデータを処理しないように設定
                                contentType: false,	// jQueryがcontentTypeを設定しないように設定
                                error: function (data) {
                                        // console.log("error:" + data);
                                        // alert("error:" + data);
                                }
                        });
                }



                function overview(h, n) {
                        if (h == "on") {
                                document.getElementById("black_box").style.display = "";
                                if (n == "1")
                                        document.getElementById("theme_detail_box").style.display = "";
                                else if (n == "2")
                                        document.getElementById("overview_detail_box").style.display = "";
                                else if (n == "3")
                                        document.getElementById("situation_detail_box").style.display = "";
                                else if (n == "4")
                                        document.getElementById("history_image_detail_box").style.display = "";
                        } else if (h == "off") {
                                document.getElementById("black_box").style.display = "none";
                                document.getElementById("theme_detail_box").style.display = "none";
                                document.getElementById("overview_detail_box").style.display = "none";
                                document.getElementById("situation_detail_box").style.display = "none";
                                document.getElementById("history_image_detail_box").style.display = "none";

                        }

                }

                //エラー系のリセット
                function error_reset() {
                        document.getElementById("required_error").style.display = "none";
                        document.getElementById("situation_input_text").style.color = "";
                        document.getElementById("feature_input_text").style.color = "";
                        document.getElementById("age_input_text").style.color = "";
                        document.getElementById("sex_input_text").style.color = "";
                }

                //作成する種類の変更
                function exchange_card(h) {
                        error_reset();
                        document.getElementById("confirm_situation").style.display = "none";
                        document.getElementById("confirm_human").style.display = "none";
                        if (mode == "new")
                                switch (h) {
                                        case "human":
                                                document.getElementById("situation_card").style.display = "none";
                                                document.getElementById("human_card").style.display = "";
                                                break;
                                        case "situation":
                                                document.getElementById("situation_card").style.display = "";
                                                document.getElementById("human_card").style.display = "none";
                                                break;
                                }
                        else if (mode == "reuse")
                                switch (h) {
                                        case "human":
                                                document.getElementById("reuse_situation_card").style.display = "none";
                                                document.getElementById("reuse_human_card").style.display = "";
                                                break;
                                        case "situation":
                                                document.getElementById("reuse_situation_card").style.display = "";
                                                document.getElementById("reuse_human_card").style.display = "none";
                                                break;
                                }
                }

                //新規・再利用の切り替え
                function exchange_mode(h) {

                        switch (h) {
                                case "input":
                                        document.getElementById("cope_input").style.display = "";
                                        document.getElementById("confirm_cope").style.display = "none";
                                        break;
                                case "confirm":
                                        document.getElementById("cope_input").style.display = "none";
                                        document.getElementById("confirm_cope").style.display = "";
                                        break;
                                case "none":
                                        document.getElementById("cope_input").style.display = "none";
                                        document.getElementById("confirm_cope").style.display = "none";
                                        break;
                        }
                }

                //新規状況対応
                function new_cope(h) {
                        
                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        code: window.sessionStorage.getItem(["eventcode"]),
                                        num: h
                                },
                                success: function (data) {
                                        console.log(data);
                                        // 状況
                                        $("#situation_text").empty();
                                        $("#situation_text").append(data[0].data1);
                                        $("#confirm_situation_text").empty();
                                        $("#confirm_situation_text").append(data[0].data1);

                                        //画像
                                        if (data[0].id == "2" && data[0].data3 != "") {

                                        }
                                        else if (data[0].id == "2" && data[0].data3 == "") {
                                                $("#image_draw").empty();
                                                $("#image_draw").append("なし");
                                        }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        // alert('エラーです！'); //エラーを表示
                                        console.log("新規状況データ書き込みエラー");
                                }
                        });
                        exchange_mode("input");
                }

                //再利用するデータを決めたとき
                function reuse_select(select_num) {

                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        code: window.sessionStorage.getItem(["eventcode"]),
                                        num: select_num
                                },
                                success: function (data) {
                                        console.log(data);
                                        if (data[0].id == "2") {
                                                var get1 = document.forms.input1;
                                                get1.situation.value = data[0].data1;
                                                data[0].data2 = data[0].data2.split("/");
                                                for (var i = 0; i < assessment_data[0].length; i++) {
                                                        document.getElementById("assessment_list" + i).value = data[0].data2[i];
                                                }
                                                exchange_mode("new");
                                        }
                                        else if (data[0].id == "3") {
                                                var get1 = document.forms.input_human;
                                                get1.feature.value = data[0].data1;
                                                get1.age.value = data[0].data2;
                                                get1.sex.value = data[0].data3;
                                                exchange_mode("new");
                                        }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        // alert('エラーです！'); //エラーを表示
                                        console.log("data");
                                }
                        });
                }
        </script>

</body>

</html>