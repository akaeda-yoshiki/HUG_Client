<!DOCTYPE html>
<html>

<head>
        <meta charset="UTF-8" />
        <title>プレイ画面</title>
        <link rel="stylesheet" type="text/css" href="play.css">
        <script type="text/javascript" src="define.js"> </script>
        <script src="https://code.jquery.com/jquery-1.9.0.min.js"></script>
        <script type="text/javascript" src="jquery.balloon.js"></script>
        <script type="text/javascript" src="play_common.js"></script>
        <script type="text/javascript" src="figure.js"></script>
        <style type="text/css">
                canvas {
                        /* background: rgb(255, 255, 255); */
                        background: url(image.jpeg);
                        background-size: cover;
                        border: 1px solid #999;
                        /* position: absolute;
                    top: 32px;
                    left: 8px; */

                }

                input[type=radio] {
                        display: none;
                        /* ラジオボタンを非表示にする */
                }

                input[type="radio"]:checked+label {
                        background: #31A9EE;
                        /* マウス選択時の背景色を指定する */
                        color: #ffffff;
                        /* マウス選択時のフォント色を指定する */
                }

                .label {
                        display: block;
                        /* ブロックレベル要素化する */
                        float: left;
                        /* 要素の左寄せ・回り込を指定する */
                        margin: 5px;
                        /* ボックス外側の余白を指定する */
                        width: 50px;
                        /* ボックスの横幅を指定する */
                        height: 30px;
                        /* ボックスの高さを指定する */
                        padding-left: 5px;
                        /* ボックス内左側の余白を指定する */
                        padding-right: 5px;
                        /* ボックス内御右側の余白を指定する */
                        color: #b20000;
                        /* フォントの色を指定 */
                        text-align: center;
                        /* テキストのセンタリングを指定する */
                        cursor: pointer;
                        /* マウスカーソルの形（リンクカーソル）を指定する */
                        border: 2px solid #006DD9;
                        /* ボックスの境界線を実線で指定する */
                        border-radius: 5px;
                        /* 角丸を指定する */
                }

                .label:hover {
                        background-color: rgb(142, 194, 250);
                        /* マウスオーバー時の背景色を指定する */
                }
        </style>
        <script>


                $('texi_and_pop').balloon();//マウスオーバーの割り当て

                var assessment_data = [];
                //受信
                $(document).ready(function () {
                        window.sessionStorage.setItem(["eventcode"], "5SrgaP0MjG");
                        get_theme_detail();

                        var list = '<option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>';

                        if (DEBUG) {
                                $.ajax({ //非同期通信
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                        data: {
                                                code: window.sessionStorage.getItem(["eventcode"])
                                        },
                                        success: function (data1) {
                                                // alert(data1);
                                                $.ajax({ //非同期通信
                                                        type: "POST",
                                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/theme.php",
                                                        data: {
                                                                id: data1
                                                        },
                                                        success: function (data) {
                                                                var text1 = '<br><a style="position: relative;left: 140px;">';
                                                                var text2 = '：</a><select id="assessment_list';
                                                                var text3 = '" style="position: relative;width: 50px;left: 158px;">';

                                                                var add = "";
                                                                add += '<a style="position: relative;left: 40px;">' + data[0].assessment0 + '：</a>';
                                                                add += '<select id="assessment_list' + 0 + '" style="position: relative;width: 50px;left: 60px;">';
                                                                $("#assessment_list").append(add + list);
                                                                assessment_data.push(data[0].assessment0);
                                                                if (data[0].assessment1 != "") { $("#assessment_list").append(text1 + data[0].assessment1 + text2 + 1 + text3 + list); assessment_data.push(data[0].assessment1); }
                                                                if (data[0].assessment2 != "") { $("#assessment_list").append(text1 + data[0].assessment2 + text2 + 2 + text3 + list); assessment_data.push(data[0].assessment2); }
                                                                if (data[0].assessment3 != "") { $("#assessment_list").append(text1 + data[0].assessment3 + text2 + 3 + text3 + list); assessment_data.push(data[0].assessment3); }
                                                                if (data[0].assessment4 != "") { $("#assessment_list").append(text1 + data[0].assessment4 + text2 + 4 + text3 + list); assessment_data.push(data[0].assessment4); }
                                                                if (data[0].assessment5 != "") { $("#assessment_list").append(text1 + data[0].assessment5 + text2 + 5 + text3 + list); assessment_data.push(data[0].assessment5); }
                                                                if (data[0].assessment6 != "") { $("#assessment_list").append(text1 + data[0].assessment6 + text2 + 6 + text3 + list); assessment_data.push(data[0].assessment6); }
                                                                if (data[0].assessment7 != "") { $("#assessment_list").append(text1 + data[0].assessment7 + text2 + 7 + text3 + list); assessment_data.push(data[0].assessment7); }
                                                                if (data[0].assessment8 != "") { $("#assessment_list").append(text1 + data[0].assessment8 + text2 + 8 + text3 + list); assessment_data.push(data[0].assessment8); }
                                                                if (data[0].assessment9 != "") { $("#assessment_list").append(text1 + data[0].assessment9 + text2 + 9 + text3 + list); assessment_data.push(data[0].assessment9); }

                                                        },
                                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                                // alert('エラーです！'); //エラーを表示
                                                                console.log("えらー:" + textStatus);
                                                        }
                                                });
                                        },
                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                // alert('エラーです！'); //エラーを表示
                                        }
                                });

                                get_history();
                                init();
                        }
                });


                //ID指定のデータの受信
                function get_id_data(get_id) {
                        if (DEBUG)
                                $.ajax({ //非同期通信
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                        data: {
                                                code: window.sessionStorage.getItem(["eventcode"]),
                                                id: get_id
                                        },
                                        success: function (data) {
                                                return data;
                                        },
                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                // alert('エラーです！'); //エラーを表示
                                                console.log("えらー:" + textStatus);
                                        }
                                });
                        return null;
                }

        </script>
</head>

<body>
        <script>
                $(function () { $("#include_common").load("play_common.html"); })
        </script>

        <div id="include_common">
        </div>
        <br><br><br>
        <!-- 新規入力画面 *************************************************************-->
        <form id="cope_input" style="display: none;">
                <div class="block1" id="situation">
                        状況*<br>
                        <draw_area id="situation_text"></draw_area>
                </div>
                <div class="block2">
                        画像
                        <div id="image_draw"></div>

                </div>
                <!-- 対応 -->
                <div class="block1">
                        <text_and_pop id="cope_input_text" title="状況への対応を記入してください" style="position: relative;top:-30px;">対応*
                                <b style="font-size: 10px;">(100字以内)</b>
                        </text_and_pop>
                        <textarea id="cope" maxlength='100' class="textarea_smoll" wrap="soft" style="position: relative; left:0px;top:-30%;"
                                required></textarea>
                        <input type="button" value="エリアの操作する" id="area_operate_on_button" onclick='erea_operate_swcth(true)'
                                style="position: relative;left: 130px;">
                        <input type="button" value="エリアの操作をや取り消す" id="area_operate_off_button" onclick='erea_operate_swcth(false)'
                                style="display: none;position: relative;left: 130px;">
                </div>


                <!-- </center> -->
                <datalist id="color_list">
                        <option value="#ff0000">#ff0000</option>
                        <option value="#00ff00">#00ff00</option>
                        <option value="#0000ff">#0000ff</option>
                </datalist>
                <datalist id="label_text_list">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                </datalist>
                <br>
                <a style="position: relative; left:35%;">
                        <!-- ボタン -->
                        <input type="button" value="次へ" onclick='next("situation")'>
                </a>
        </form>
        <br>
        <!-- エリア操作画面 -->
        <div class="block1" id="erea_operate"style="display: none;">

                <form id="select_figure">
                        <input type="radio" name="figure" value="□" id="rect">
                        <label for="rect" class="label">□</label>

                        <input type="radio" name="figure" value="〇" id="circle">
                        <label for="circle" class="label">〇</label>

                        <input type="radio" name="figure" value="△" id="triangle">
                        <label for="triangle" class="label">△</label>
                        <input type="radio" name="figure" value="no" id="no">

                </form>
                <form id="create_figure">

                        <br>
                        <br> 図形の色
                        <input type="color" name="figure_color" list="color_list" value="#00ff00">
                        <br> ラベル名
                        <input type="text" name="label_text" list="label_text_list" required>
                        <br>ラベルの色
                        <input type="color" name="label_color" list="color_list" value="#ff0000">

                        <br>
                        <input type="button" id="create" value="新規作成" onclick="create_figure()">
                        <input type="button" id="edit" value="変更" onclick="create_figure()">
                        <input type="button" value="削除" onclick="figure_delete()">

                </form>
                <br>
                <canvas id="canvas" width="400" height="400"></canvas>
        </div>
        <!-- 確認画面 *************************************************************-->
        <form id="confirm_cope" style="display: none;">
                <div class="block1" id="situation">
                        状況*<br>
                        <draw_area id="confirm_situation_text"></draw_area>
                </div>
                <div class="block2">
                        画像
                        <div id="confirm_image_draw"></div>

                </div>
                <!-- 対応 -->
                <div class="block1">
                        対応*<br>
                        <draw_area id="confirm_cope_text"></draw_area>
                </div>
                <br>
                <a style="position: relative; left:27%;">
                        <!-- ボタン -->
                        <input type="button" value="訂正" onclick='exchange_mode("input")'> &nbsp; &nbsp; &nbsp; &nbsp;
                        <input type="button" value="内容確定" onclick='decide("situation")'>
                </a>
        </form>
        <!-- エラーメッセージ -->
        <a id="required_error" style="position: relative; left:26%;color: red;display: none;">
                <br>入力内容に不備があります。
                <br>
                <br>
        </a>
        <script>
                var now_situation_number = "";
                var assessment_send = [], category_send, time_send = "", image_send = "";//登録時に送信する用
                var mode = "new";//新規作成か再利用の識別変数
                //次へボタンが押された時
                function next() {
                        var required_flag = true;//入力必須事項の確認用

                        var get1 = document.forms.cope_input;
                        $("#confirm_cope_text").empty();
                        $("#confirm_cope_text").append(get1.cope.value);
                        if (get1.cope.value == "") {
                                document.getElementById("required_error").style.display = "";
                                document.getElementById("cope_input_text").style.color = "red";
                        }
                        else {
                                error_reset();
                                exchange_mode("confirm");
                        }
                }


                var send_f = 1;
                //内容確定ボタンが押された
                function decide(h) {
                        var get1 = document.forms.cope_input;
                        var file_name = "";
                        console.log(now_situation_number);
                        // var form = document.getElementById("file_input");
                        // var a = document.getElementById("image_file");
                        // alert(a.value);
                        // if (a.value != "")
                        //         file_name = window.sessionStorage.getItem(["eventcode"]);
                        if (send_f == 1) {
                                send_f = 0;
                                $.ajax({ //非同期通信
                                        type: "POST",
                                        url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                        data: {
                                                data1: get1.cope.value,
                                                data2: now_situation_number,
                                                data3: file_name,
                                                data4: "21:20",
                                                code: window.sessionStorage.getItem(["eventcode"]),
                                                mode: "insert",
                                                id: 4
                                        },
                                        success: function (data) {
                                                // console.log(data);
                                                // alert(data);
                                                data = data.split("/");
                                                if (data[1] != "")
                                                        file(data[1]);
                                                if (data[0] == "ok") {
                                                        window.location.href = "ps.html";
                                                }
                                                else {
                                                        alert("ok以外");
                                                }
                                                send_f = 1;
                                        },
                                        error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                                // alert('エラーです！'); //エラーを表示
                                                send_f = 1;
                                                console.log("えらー:" + textStatus);
                                        }
                                });
                        }
                }
                function file(num) {
                        var form = document.getElementById("file_input");
                        var formdata = new FormData(form);
                        // console.log();
                        // if (form != "")
                        $.ajax({
                                type: 'POST',
                                url: 'http://192.168.0.159/2018grade4/HUG/HUG_Server/file_upload.php?code=' + window.sessionStorage.getItem(["eventcode"]) + '&&num=' + num,
                                data: formdata,
                                processData: false,	// jQueryがデータを処理しないように設定
                                contentType: false,	// jQueryがcontentTypeを設定しないように設定
                                error: function (data) {
                                        // console.log("error:" + data);
                                        // alert("error:" + data);
                                }
                        });
                }



                function overview(h, n) {
                        if (h == "on") {
                                document.getElementById("black_box").style.display = "";
                                if (n == "1")
                                        document.getElementById("theme_detail_box").style.display = "";
                                else if (n == "2")
                                        document.getElementById("overview_detail_box").style.display = "";
                                else if (n == "3")
                                        document.getElementById("situation_detail_box").style.display = "";
                                else if (n == "4")
                                        document.getElementById("history_image_detail_box").style.display = "";
                        } else if (h == "off") {
                                document.getElementById("black_box").style.display = "none";
                                document.getElementById("theme_detail_box").style.display = "none";
                                document.getElementById("overview_detail_box").style.display = "none";
                                document.getElementById("situation_detail_box").style.display = "none";
                                document.getElementById("history_image_detail_box").style.display = "none";

                        }

                }

                //エラー系のリセット
                function error_reset() {
                        document.getElementById("required_error").style.display = "none";
                        document.getElementById("cope_input_text").style.color = "";
                }


                //新規・再利用の切り替え
                function exchange_mode(h) {

                        switch (h) {
                                case "input":
                                        document.getElementById("cope_input").style.display = "";
                                        document.getElementById("confirm_cope").style.display = "none";
                                        break;
                                case "confirm":
                                        document.getElementById("cope_input").style.display = "none";
                                        document.getElementById("confirm_cope").style.display = "";
                                        break;
                                case "none":
                                        document.getElementById("cope_input").style.display = "none";
                                        document.getElementById("confirm_cope").style.display = "none";
                                        break;
                        }
                }

                //新規状況対応
                function new_cope(h) {

                        $.ajax({ //非同期通信
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/eventcode.php",
                                data: {
                                        code: window.sessionStorage.getItem(["eventcode"]),
                                        num: h
                                },
                                success: function (data) {
                                        now_situation_number = "" + data[0].num;
                                        // console.log(data);
                                        // 状況
                                        $("#situation_text").empty();
                                        $("#situation_text").append(data[0].data1);
                                        $("#confirm_situation_text").empty();
                                        $("#confirm_situation_text").append(data[0].data1);

                                        //画像
                                        if (data[0].id == "2" && data[0].data3 != "") {

                                        }
                                        else if (data[0].id == "2" && data[0].data3 == "") {
                                                $("#image_draw").empty();
                                                $("#image_draw").append("なし");
                                                $("#confirm_image_draw").empty();
                                                $("#confirm_image_draw").append("なし");
                                        }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        // alert('エラーです！'); //エラーを表示
                                        console.log("新規状況データ書き込みエラー");
                                }
                        });
                        exchange_mode("input");
                }

                //エリア操作のオンオフを変更
                function erea_operate_swcth(h) {
                        if (h) {
                                draw_flag = true;
                                document.getElementById("area_operate_on_button").style.display = "none";
                                document.getElementById("area_operate_off_button").style.display = "";
                                document.getElementById("erea_operate").style.display = "";
                        } else {
                                draw_flag = false;
                                document.getElementById("area_operate_on_button").style.display = "";
                                document.getElementById("area_operate_off_button").style.display = "none";
                                document.getElementById("erea_operate").style.display = "none";
                        }
                }
                var debug = false;//通信のオンオフ（１：オフ）
                var draw_flag = false;
                if (debug == true)
                        var mynumber = sessionStorage.getItem('mynumber') - 1;//自分のユーザーIDを取得
                else
                        mynumber = 1;
                document.write(mynumber);
                var ev;
                var figure_info = [];//図形の情報
                var canvas = document.getElementById("canvas");
                var figure_ctx = canvas.getContext("2d");
                var size_change_marker = {//図形を拡大縮小可能時に表示されるマーカー
                        place: {
                                x: -10,
                                y: -10,
                                width: 8,
                                height: 8
                        },
                        color: "blue",
                        ctx: canvas.getContext("2d")
                };
                var rectx = 0, recty = 0;
                var myedit = -1;//現在選択している図形のID
                var mousex = 0, mousey = 0;//画面上のマウスの座標
                var imag_mousex, imag_mousey;//図形範囲内でのマウスの座標
                var change_flag = 0;


                //初期化処理
                function init() {
                        setInterval(draw, 100);
                        if (debug == true)
                                get_user_info();//他のユーザー情報の取得

                        // figure_init();//画像関係の初期化処理
                }


                //マウスが動いた時
                function handleMouseMove(e) {
                        event = e; // IE対応
                        ev = event;
                        //画面上のマウスの座標
                        mousex = event.clientX;
                        mousey = event.clientY;

                        //画像上のマウスの座標
                        imag_mousex = mousex - canvas.getBoundingClientRect().left;
                        imag_mousey = mousey - canvas.getBoundingClientRect().top;

                        if (myedit != -1 && figure_info[myedit].stats != FIGURE.MOVE)
                                size_change_marker_move();

                }


                //更新処理
                function draw() {
                        if (draw_flag) {
                                // console.log(mousex + "::" + mousey + "::::::" + figure[mynumber][0] + "~" + (figure[mynumber][0] + x1) + "::" + figure[mynumber][1] + "~" + (figure[mynumber][1] + y1));
                                // console.log(myedit);
                                window.onmousemove = handleMouseMove;
                                if (debug == true)
                                        recieve();
                                clear_figure();
                                if (myedit != -1)
                                        switch (figure_info[myedit].stats) {
                                                case FIGURE.MOVE://座標の更新
                                                        // if (figure_info[myedit].TYPE == TYPE.TRIANGLE) {

                                                        // } else {
                                                        figure_info[myedit].place[0] = mousex - canvas.getBoundingClientRect().left - rectx;
                                                        figure_info[myedit].place[1] = mousey - canvas.getBoundingClientRect().top - recty;
                                                        // }
                                                        break;
                                                case FIGURE.CHANGE:
                                                        size_change();
                                                        break;
                                        }
                                draw_figure();//図形の描画

                                // size_change_flag();
                        }
                }

                //マウスが押された時
                document.onmousedown = function (e) {
                        if (!e) e = window.event; // レガシー
                        // console.log(canvas.getBoundingClientRect().left + ":" + canvas.getBoundingClientRect().top + ":" + canvas.getBoundingClientRect().width + ":" + canvas.getBoundingClientRect().height + "::::" + mousex + ":" + mousey);
                        //画像上にマウスがあるか判定
                        if (rect_judge(canvas.getBoundingClientRect().left, canvas.getBoundingClientRect().width, canvas.getBoundingClientRect().top, canvas.getBoundingClientRect().height, mousex, mousey))
                                for (var i = 0; i < figure_info.length; i++)
                                        //図形の上にマウスがあるか判定
                                        if (place_judge(i)) {
                                                myedit = i;
                                                var get = document.getElementById("select_figure");
                                                // get.figure.value = figure_info[i].type;
                                                get.style.display = "none";
                                                $("#create").prop("disabled", true);
                                                $("#edit").prop("disabled", false);

                                                get = document.getElementById("create_figure");
                                                var result = (figure_info[i].color).split(",");
                                                get.figure_color.value = rgb_to_16(result);

                                                result = (figure_info[i].label_color).split(",");
                                                get.label_color.value = rgb_to_16(result);
                                                get.label_text.value = figure_info[i].label_text;

                                                if (size_change_flag() == 1)
                                                        figure_info[myedit].stats = FIGURE.CHANGE;
                                                else {
                                                        rectx = imag_mousex - figure_info[myedit].place[0];
                                                        recty = imag_mousey - figure_info[myedit].place[1];
                                                        clear_figure();
                                                        // figure_info[myedit].place[0] = mousex - canvas.getBoundingClientRect().left - rectx;
                                                        // figure_info[myedit].place[1] = mousey - canvas.getBoundingClientRect().top - recty;

                                                        figure_info[myedit].stats = FIGURE.MOVE;
                                                        draw_figure();
                                                }
                                                break;
                                        }
                                        else {
                                                myedit = -1;
                                                $("#create").prop("disabled", false);
                                                $("#edit").prop("disabled", true);

                                                var get = document.getElementById("select_figure");
                                                get.style.display = "";
                                                get.figure.value = "no";
                                                // console.log(get.figure.value);
                                                var get = document.getElementById("create_figure");
                                                get.figure_color.value = COLOR16.GREEN;
                                                get.label_text.value = "";
                                                get.label_color.value = COLOR16.RED;

                                        }
                }

                //マウスが離された時
                window.onmouseup = function (e) {
                        // console.log("離された");
                        if (myedit != -1)
                                figure_info[myedit].stats = FIGURE.NULL;
                        // myedit = -1;
                        change_flag = 0;
                }

                //他のユーザー情報の取得
                function get_user_info() {
                        $.ajax({
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/read_user.php",
                                dataType: "json",
                        }).done(function (data, dataType) {
                                for (var i = 0; i < data.length; i++) {
                                        $("user_info").append("name : " + data[i].name + "&nbsp;" + data[i].role + "<br>");
                                }
                        }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                                // alert('Error : ' + errorThrown);
                        });
                }

                //図形情報の取得
                function recieve() {
                        $.ajax({
                                type: "POST",
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/read_share.php",
                                dataType: "json",
                        }).done(function (data, dataType) {
                                for (var i = 0; i < data.length; i++) {
                                        // if (data[i].number - 1 != mynumber) {
                                        //     figure[data[i].number - 1][0] = data[i].data1;
                                        //     figure[data[i].number - 1][1] = data[i].data2;
                                        //     figure[data[i].number - 1][2] = data[i].data3;
                                        //     figure[data[i].number - 1][3] = data[i].data4;

                                        // }

                                        //色とIDとラベル関係***********************************************************
                                        var place = [data[i].data1, data[i].data2, data[i].data3, data[i].data4];
                                        figure_info.push(new rect(0, TYPE.RECT, place, FIGURE.NULL, "green", "red", "ラベル", canvas.getContext("2d")));

                                }
                        }).fail(function (XMLHttpRequest, textStatus, errorThrown) {
                                // alert('Error : ' + errorThrown);
                        });
                        clear_figure();
                        draw_figure();
                }

                //図形情報の送信
                function send() {
                        $.ajax({ //ajaxによる非同期通信発生
                                type: "POST", //POST送信でデータを受け渡す
                                url: "http://192.168.0.159/2018grade4/HUG/HUG_Server/share_insert.php",
                                data: {
                                        //色々変える必要あり***********************************************************
                                        info_id: 1,
                                        number: sessionStorage.getItem('mynumber'),
                                        data1: figure[mynumber][0],
                                        data2: figure[mynumber][1],
                                        data3: figure[mynumber][2],
                                        data4: figure[mynumber][3]
                                },
                                success: function (hoge) { //接続が成功
                                        // alert(hoge);
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { //接続が失敗
                                        // alert(errorThrown); //エラーを表示
                                }
                        });
                        return false;
                }

                function create_figure() {
                        var get = document.getElementById("select_figure");
                        // var get = document.forms.select_figure;
                        switch (get.figure.value) {
                                case TYPE.RECT:
                                        create_rect();
                                        break;
                                case TYPE.CIRCLE:
                                        create_circle();

                                        break;
                                case TYPE.TRIANGLE:
                                        create_triangle();
                                        break;
                        }
                }
        </script>

</body>

</html>